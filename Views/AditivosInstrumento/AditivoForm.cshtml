@using Financeiro.Models
@model Financeiro.Models.ViewModels.AditivoViewModel
@using System.Globalization

@{
    ViewBag.Title = "Registrar Aditivo do Instrumento";
    Layout = "_Layout";
    var atual = ViewBag.VersaoAtual as AcordoVersao;
    var br = new CultureInfo("pt-BR");
}

<div class="container py-4" style="max-width: 980px;">
    <div class="text-center mb-4">
        <h2 class="fw-bold text-primary">@ViewBag.Title</h2>
        <p class="text-muted">Preencha os dados do aditivo para o instrumento abaixo.</p>
    </div>

    @if (atual != null)
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="badge bg-info-subtle text-info fw-semibold">Versão atual</span>
                            <span class="badge bg-primary-subtle text-primary">v @atual.Versao</span>
                        </div>

                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="text-muted small">Valor vigente</div>
                                <div class="fs-5 fw-bold">@atual.Valor.ToString("C", br)</div>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="text-muted small">Vigência</div>
                                <div class="fw-semibold">
                                    @($"{atual.VigenciaInicio:dd/MM/yyyy}") —
                                    @(atual.VigenciaFim.HasValue ? atual.VigenciaFim.Value.ToString("dd/MM/yyyy") : "atual")
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ms-auto">
                        <i class="bi bi-file-earmark-text text-info" style="font-size:2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    }

    <div asp-validation-summary="ModelOnly" class="alert alert-danger d-none" id="validationSummary"></div>

    <form asp-controller="AditivosInstrumento"
          asp-action="Salvar"
          method="post"
          class="row g-3 bg-white p-4 rounded shadow-sm border position-relative"
          id="formAditivo"
          novalidate
          data-valor-atual="@((atual?.Valor ?? 0m).ToString("0.##", CultureInfo.InvariantCulture))">
        @Html.AntiForgeryToken()
        <input asp-for="TipoAcordoId" type="hidden" />

        <div class="col-md-6">
            <label asp-for="TipoAditivo" class="form-label fw-semibold">Tipo de Aditivo</label>
            <select asp-for="TipoAditivo"
                    asp-items="Html.GetEnumSelectList<TipoAditivo>()"
                    class="form-select"
                    id="TipoAditivo">
                <option value="">— selecione —</option>
            </select>
            <span asp-validation-for="TipoAditivo" class="text-danger small"></span>
        </div>

        <div class="col-md-6">
            <label asp-for="DataAssinatura" class="form-label fw-semibold">Data de Assinatura</label>
            <input asp-for="DataAssinatura" type="date" class="form-control" />
            <span asp-validation-for="DataAssinatura" class="text-danger small"></span>
        </div>

        <!-- Valor (sempre positivo; o sistema soma/subtrai conforme o tipo) -->
        <div class="col-md-6" id="grupoNovoValor" style="display:none;">
            <label asp-for="NovoValor" class="form-label fw-semibold">Valor</label>
            <div class="input-group">
                <span class="input-group-text">R$</span>
                <input asp-for="NovoValor" type="text" inputmode="decimal" class="form-control" id="NovoValor" />
            </div>
            <div id="ajudaValor" class="form-text fw-semibold mt-1 text-secondary"></div>
            <div id="previewValor" class="small mt-1 text-muted"></div>
            <span asp-validation-for="NovoValor" class="text-danger small"></span>
        </div>

        <!-- Vigência -->
        <div class="col-md-12" id="grp-vigencia" style="display:none;">
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="NovaDataInicio" class="form-label fw-semibold">Nova Data de Início</label>
                    <input asp-for="NovaDataInicio" type="date" class="form-control" id="NovaDataInicio" />
                    <span asp-validation-for="NovaDataInicio" class="text-danger small"></span>
                </div>
                <div class="col-md-6">
                    <label asp-for="NovaDataFim" class="form-label fw-semibold">Nova Data de Fim</label>
                    <input asp-for="NovaDataFim" type="date" class="form-control" id="NovaDataFim" />
                    <span asp-validation-for="NovaDataFim" class="text-danger small"></span>
                </div>
            </div>
        </div>

        <div class="col-12">
            <label asp-for="Observacao" class="form-label fw-semibold">Observações</label>
            <textarea asp-for="Observacao" rows="2" class="form-control" placeholder="Observações adicionais..."></textarea>
            <span asp-validation-for="Observacao" class="text-danger small"></span>
        </div>

        <div class="col-12 mt-2 d-flex gap-2">
            <button type="submit" class="btn btn-success">Salvar Aditivo</button>
            <a asp-controller="Instrumentos" asp-action="Editar" asp-route-id="@Model.TipoAcordoId" class="btn btn-outline-secondary">
                Voltar
            </a>
        </div>

        <div class="position-absolute top-0 end-0 m-3 d-none" id="flagAuto">
            <span class="badge bg-primary-subtle text-primary">Cálculo automático</span>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // aceitar formato pt-BR no client-validate
        if (window.jQuery && $.validator) {
            $.validator.methods.number = function (value, element) {
                if (this.optional(element)) return true;
                const clean = (value || '').replace(/\./g, '').replace(',', '.');
                return clean.trim() !== '' && !isNaN(clean);
            };
        }

        const selTipo   = document.getElementById('TipoAditivo');
        const grpValor  = document.getElementById('grupoNovoValor');
        const grpVig    = document.getElementById('grp-vigencia');

        const inpValor  = document.getElementById('NovoValor');
        const ajudaValor= document.getElementById('ajudaValor');
        const novaIni   = document.getElementById('NovaDataInicio');
        const novaFim   = document.getElementById('NovaDataFim');
        const preview   = document.getElementById('previewValor');
        const flagAuto  = document.getElementById('flagAuto');

        // enum atual: Prazo=1, PrazoAcrescimo=2, PrazoSupressao=3, Supressao=4, Acrescimo=5
        const T = { Prazo:1, PrazoAcrescimo:2, PrazoSupressao:3, Supressao:4, Acrescimo:5 };

        const valorAtual = Number((document.getElementById('formAditivo')?.dataset?.valorAtual) || '0');

        function show(el, on){ if (el) el.style.display = on ? 'block' : 'none'; }
        function req(el, on){ if (el){ el.required = !!on; el.setAttribute('aria-required', on ? 'true' : 'false'); } }
        function clearIfHidden(wrapper, inputs){
            if (!wrapper || wrapper.style.display !== 'none') return;
            (inputs||[]).forEach(i => { if (i) i.value = ''; });
        }

        function parsePtBr(s){ return Number((s||'').replace(/\./g,'').replace(',','.')) || 0; }
        function fmtBr(n){ try { return Number(n).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); } catch { return 'R$ ' + (n||0).toFixed(2); } }

        function atualizarPreview() {
            preview.textContent = '';
            const tipo = parseInt(selTipo?.value || '0', 10);
            const precisaValor = [T.Acrescimo, T.Supressao, T.PrazoAcrescimo, T.PrazoSupressao].includes(tipo);
            if (!precisaValor || !inpValor) return;

            const delta = parsePtBr(inpValor.value);
            if (delta <= 0) return;

            const final = (tipo === T.Supressao || tipo === T.PrazoSupressao)
                          ? (valorAtual - delta)
                          : (valorAtual + delta);

            preview.textContent = `Valor vigente: ${fmtBr(valorAtual)}  →  Valor estimado após o aditivo: ${fmtBr(final)}.`;
        }

        function atualizarAjudaValor(tipo){
            let msg = '';
            switch (tipo) {
                case T.Supressao:       msg = 'O valor digitado será SUBTRAÍDO do valor vigente do instrumento.'; break;
                case T.Acrescimo:       msg = 'O valor digitado será ACRESCENTADO ao valor vigente do instrumento.'; break;
                case T.PrazoSupressao:  msg = 'O valor digitado será SUBTRAÍDO e o prazo também será alterado.'; break;
                case T.PrazoAcrescimo:  msg = 'O valor digitado será ACRESCENTADO e o prazo também será alterado.'; break;
                default: msg = '';
            }
            ajudaValor.textContent = msg;
            flagAuto?.classList.toggle('d-none', !msg);
        }

        function aplicarTipo() {
            const tipo = parseInt(selTipo?.value || '0', 10);

            const precisaValor    = [T.Acrescimo, T.Supressao, T.PrazoAcrescimo, T.PrazoSupressao].includes(tipo);
            const precisaVigencia = [T.Prazo, T.PrazoAcrescimo, T.PrazoSupressao].includes(tipo);

            show(grpValor, precisaValor);
            show(grpVig,   precisaVigencia);

            req(inpValor, precisaValor);
            req(novaIni,  precisaVigencia);
            req(novaFim,  precisaVigencia);

            // limpar quando esconder
            clearIfHidden(grpValor, [inpValor]);
            clearIfHidden(grpVig,   [novaIni, novaFim]);

            atualizarAjudaValor(tipo);
            atualizarPreview();
        }

        selTipo?.addEventListener('change', aplicarTipo);
        inpValor?.addEventListener('input', atualizarPreview);
        aplicarTipo(); // estado inicial

        // Summary só se tiver erro
        const summary = document.getElementById("validationSummary");
        if (summary && summary.innerText.trim().length > 0) summary.classList.remove("d-none");

        // confirmação + normalização numérica antes de enviar
        const form = document.getElementById('formAditivo');
        form?.addEventListener('submit', async (e) => {
            if (window.jQuery && !$(form).valid()) return;

            if (grpValor && grpValor.style.display !== 'none' && inpValor) {
                const clean = (inpValor.value || '').replace(/\./g, '').replace(',', '.');
                if (!clean || isNaN(clean) || Number(clean) <= 0) {
                    e.preventDefault();
                    return Swal.fire({ icon:'warning', title:'Informe um valor numérico maior que zero.' });
                }
                inpValor.value = clean;
            }

            if (grpVig && grpVig.style.display !== 'none' && novaIni && novaFim) {
                if (!novaIni.value || !novaFim.value) {
                    e.preventDefault();
                    return Swal.fire({ icon:'warning', title:'Informe as duas datas de vigência.' });
                }
                // comparar apenas datas (sem hora)
                const di = new Date(novaIni.value + 'T00:00:00');
                const df = new Date(novaFim.value + 'T00:00:00');
                if (df < di) {
                    e.preventDefault();
                    return Swal.fire({ icon:'warning', title:'Data de fim não pode ser anterior ao início.' });
                }
            }

            e.preventDefault();
            const ok = await Swal.fire({
                icon:'question',
                title:'Confirmar registro do aditivo?',
                showCancelButton:true,
                confirmButtonText:'Salvar',
                cancelButtonText:'Cancelar'
            });
            if (ok.isConfirmed) form.submit();
        });

        // SweetAlert vindos do TempData (se reexibir a view)
        const okMsg  = @Html.Raw(Json.Serialize(TempData["Sucesso"]?.ToString() ?? ""));
        const errMsg = @Html.Raw(Json.Serialize(TempData["Erro"]?.ToString() ?? ""));
        if (okMsg)  Swal.fire({ icon:'success', title:'Sucesso', text: okMsg });
        if (errMsg) Swal.fire({ icon:'error',   title:'Ops',     text: errMsg });
    });
    </script>
}