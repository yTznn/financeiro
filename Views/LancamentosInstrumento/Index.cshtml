@model IEnumerable<Financeiro.Models.LancamentoInstrumento>
@using System.Globalization
@{
    var resumo = ViewBag.Resumo as Financeiro.Models.ViewModels.InstrumentoResumoViewModel;
    var comp   = (DateTime)ViewBag.Competencia;
    var br     = new CultureInfo("pt-BR");
    ViewBag.Title = "Lançamentos do Instrumento";
    Layout = "_Layout";
}

<h2 class="mb-3">Lançamentos — @resumo?.Numero (@comp.ToString("MM/yyyy"))</h2>

<div class="row g-3 mb-3">
  <div class="col-md-2"><div class="form-control-plaintext"><strong>Mensal (planejado):</strong> @resumo?.ValorMensalAtual.ToString("C", br)</div></div>
  <div class="col-md-2"><div class="form-control-plaintext"><strong>Lançado no mês:</strong> @resumo?.TotalLancadoNoMes.ToString("C", br)</div></div>
  <div class="col-md-2"><div class="form-control-plaintext"><strong>Saldo do mês:</strong> @resumo?.SaldoDoMesAtual.ToString("C", br)</div></div>
  <div class="col-md-3"><div class="form-control-plaintext"><strong>Vigência:</strong> @resumo?.VigenciaInicio.ToString("dd/MM/yyyy") → @resumo?.VigenciaFimAtual.ToString("dd/MM/yyyy")</div></div>
</div>

<div class="mb-3">
  <a class="btn btn-primary" asp-action="Novo" asp-route-instrumentoId="@resumo?.InstrumentoId"
     asp-route-ano="@comp.Year" asp-route-mes="@comp.Month">+ Novo lançamento</a>
  <a class="btn btn-secondary" asp-controller="Instrumentos" asp-action="Editar" asp-route-id="@resumo?.InstrumentoId">Voltar ao Instrumento</a>
</div>

<table class="table table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th>Competência</th>
      <th class="text-end">Valor</th>
      <th>Observação</th>
      <th class="text-center" style="width:160px">Ações</th>
    </tr>
  </thead>
  <tbody>
  @if (!(Model?.Any() ?? false))
  {
      <tr><td colspan="4" class="text-center text-muted py-4">Nenhum lançamento neste mês.</td></tr>
  }
  else
  {
      foreach (var l in Model)
      {
          <tr>
            <td>@l.Competencia.ToString("MM/yyyy")</td>
            <td class="text-end">@l.Valor.ToString("C", br)</td>
            <td>@l.Observacao</td>
            <td class="text-center">
              <a class="btn btn-sm btn-outline-primary" asp-action="Editar" asp-route-id="@l.Id">Editar</a>
              <form class="d-inline js-delete" asp-action="Excluir" asp-route-id="@l.Id" method="post" data-label="@l.Competencia.ToString("MM/yyyy")">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-sm btn-outline-danger">Excluir</button>
              </form>
            </td>
          </tr>
      }
  }
  </tbody>
</table>

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // SweetAlerts de TempData (mensagens do controller)
    (function () {
      const ok  = @Html.Raw(Json.Serialize(TempData["Sucesso"]?.ToString() ?? ""));
      const err = @Html.Raw(Json.Serialize(TempData["Erro"]?.ToString() ?? ""));
      if (ok)  Swal.fire({ icon:'success', title:'Sucesso', text: ok });
      if (err) Swal.fire({ icon:'error',   title:'Ops',     text: err });
    })();

    // Confirmação de exclusão
    (function wireDeleteConfirm(){
      document.querySelectorAll('form.js-delete').forEach(f => {
        if (f.dataset.bound === '1') return;
        f.dataset.bound = '1';
        f.addEventListener('submit', function(e){
          e.preventDefault();
          const label = this.getAttribute('data-label') || 'este lançamento';
          Swal.fire({
            icon: 'warning',
            title: 'Confirmar exclusão?',
            text: `Você está prestes a excluir o lançamento de ${label}.`,
            showCancelButton: true,
            confirmButtonText: 'Excluir',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d'
          }).then(res => { if (res.isConfirmed) this.submit(); });
        });
      });
    })();
  </script>
}