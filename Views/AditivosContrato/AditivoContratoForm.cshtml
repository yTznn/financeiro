@model Financeiro.Models.ViewModels.AditivoContratoViewModel
@using Financeiro.Models
@using System.Globalization

@{
    ViewBag.Title  = "Registrar Aditivo de Contrato";
    Layout         = "_Layout";
    var versaoAtual = ViewBag.VersaoAtual as ContratoVersao;
    var br = new CultureInfo("pt-BR");
}

@* --- MENSAGENS DE SUCESSO/ERRO (SWEETALERT) --- *@
<div id="pageFlags"
     data-success="@(TempData["MensagemSucesso"] ?? TempData["Sucesso"])"
     data-error="@(TempData["MensagemErro"] ?? TempData["Erro"])"></div>

<div class="container-md mt-4" style="max-width: 980px;">
    <div class="text-center mb-4">
        <h2 class="fw-bold">@ViewBag.Title</h2>
        <p class="text-muted mb-0">Preencha os dados do novo aditivo para o contrato abaixo.</p>
    </div>

    @* ——— Versão atual do contrato ——— *@
    @if (versaoAtual != null)
    {
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-3 p-md-4">
                <div class="d-flex flex-wrap align-items-center gap-3">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center gap-2 mb-1">
                            <span class="badge bg-info-subtle text-info fw-semibold">Versão atual</span>
                            <span class="badge bg-primary-subtle text-primary">v @versaoAtual.Versao</span>
                        </div>

                        <div class="text-muted small">Objeto</div>
                        <div class="fw-semibold mb-2">@versaoAtual.ObjetoContrato</div>

                        <div class="row g-3">
                            <div class="col-12 col-md-4">
                                <div class="text-muted small">Valor vigente (Total)</div>
                                <div class="fs-5 fw-bold">@versaoAtual.ValorContrato.ToString("C", br)</div>
                            </div>
                            <div class="col-12 col-md-8">
                                <div class="text-muted small">Vigência</div>
                                <div class="fw-semibold">
                                    @($"{versaoAtual.DataInicio:dd/MM/yyyy}") — @($"{versaoAtual.DataFim:dd/MM/yyyy}")
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="ms-auto">
                        <i class="bi bi-file-earmark-text text-info" style="font-size:2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    }

    @* Summary de validação padrão do ASP.NET *@
    <div asp-validation-summary="All" class="alert alert-danger d-none" id="validationSummary"></div>

    <form asp-action="Salvar"
          method="post"
          class="row g-3 bg-white p-4 rounded shadow-sm border position-relative"
          id="formAditivoContrato"
          novalidate
          data-valor-atual="@((versaoAtual?.ValorContrato ?? 0m).ToString("0.##", CultureInfo.InvariantCulture))"
          data-fim-atual="@(versaoAtual?.DataFim.ToString("yyyy-MM-dd") ?? "")">
        
        @Html.AntiForgeryToken()
        <input asp-for="ContratoId" type="hidden" />

        <div class="col-md-4">
            <label asp-for="TipoAditivo" class="form-label fw-semibold">Tipo de Aditivo</label>
            <select asp-for="TipoAditivo"
                    asp-items="Html.GetEnumSelectList<TipoAditivo>()"
                    class="form-select" id="tipoAditivoSelect">
                <option value="">— selecione —</option>
            </select>
            <span asp-validation-for="TipoAditivo" class="text-danger small"></span>
        </div>

        <div class="col-md-4">
            <label asp-for="DataInicioAditivo" class="form-label fw-semibold">Início do Aditivo</label>
            <input asp-for="DataInicioAditivo" type="date" class="form-control" id="DataInicioAditivo" />
            <span asp-validation-for="DataInicioAditivo" class="text-danger small"></span>
        </div>

        <div class="col-md-4" id="campo-novo-valor" style="display:none;">
            <label asp-for="NovoValor" class="form-label fw-semibold">Valor (positivo)</label>
            <div class="input-group">
                <span class="input-group-text">R$</span>
                <input asp-for="NovoValor" type="text" class="form-control money" id="NovoValor" />
            </div>
            
            <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" asp-for="EhValorMensal" id="EhValorMensal">
                <label class="form-check-label text-muted small" for="EhValorMensal">
                    É um acréscimo/desconto na parcela mensal?
                </label>
            </div>

            <div id="ajudaValor" class="form-text fw-semibold mt-1 text-secondary"></div>
            <div id="previewValor" class="small mt-1 text-muted bg-light p-2 rounded"></div>
            <span asp-validation-for="NovoValor" class="text-danger small"></span>
        </div>

        <div class="col-md-4" id="campo-nova-data" style="display:none;">
            <label asp-for="NovaDataFim" class="form-label fw-semibold">Nova Data de Fim</label>
            <input asp-for="NovaDataFim" type="date" class="form-control" id="NovaDataFim" />
            <span asp-validation-for="NovaDataFim" class="text-danger small"></span>
        </div>

        <div class="col-12" id="campo-novo-objeto" style="display:none;">
            <label asp-for="NovoObjeto" class="form-label fw-semibold">Novo Objeto</label>
            <textarea asp-for="NovoObjeto" class="form-control" rows="3"></textarea>
            <span asp-validation-for="NovoObjeto" class="text-danger small"></span>
        </div>

        <div class="col-12">
            <label asp-for="Observacao" class="form-label fw-semibold">Observações</label>
            <textarea asp-for="Observacao"
                      class="form-control"
                      placeholder="Observações adicionais..."
                      rows="2"></textarea>
            <span asp-validation-for="Observacao" class="text-danger small"></span>
        </div>

        <div class="col-12 d-flex gap-2 pt-2">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-save2-fill me-1"></i> Salvar Aditivo
            </button>
            <a asp-controller="Contratos" asp-action="Editar" asp-route-id="@Model.ContratoId" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left-circle me-1"></i> Cancelar
            </a>
        </div>

        <div class="position-absolute top-0 end-0 m-3 d-none" id="flagAuto">
            <span class="badge bg-primary-subtle text-primary">Cálculo automático</span>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        // Aceitar formato PT-BR no validator
        if (window.jQuery && $.validator) {
            $.validator.methods.number = function (value, element) {
                return this.optional(element) || 
                       /^-?(?:\d+|\d{1,3}(?:\.\d{3})+)(?:,\d+)?$/.test(value) ||
                       /^-?\d+(?:[\.,]\d+)?$/.test(value);
            };
        }

        const form          = document.getElementById('formAditivoContrato');
        const tipoSelect    = document.getElementById('tipoAditivoSelect');
        const campoValor    = document.getElementById('campo-novo-valor');
        const campoData     = document.getElementById('campo-nova-data');
        const campoObj      = document.getElementById('campo-novo-objeto');
        const inpValor      = document.getElementById('NovoValor');
        const chkMensal     = document.getElementById('EhValorMensal');
        const ajudaValor    = document.getElementById('ajudaValor');
        const preview       = document.getElementById('previewValor');
        const novaFim       = document.getElementById('NovaDataFim');
        const iniAditivo    = document.getElementById('DataInicioAditivo');
        const flagAuto      = document.getElementById('flagAuto');

        // enum: Prazo=1, PrazoAcrescimo=2, PrazoSupressao=3, Supressao=4, Acrescimo=5
        const T = { Prazo:1, PrazoAcrescimo:2, PrazoSupressao:3, Supressao:4, Acrescimo:5 };

        const valorAtual = Number(form?.dataset?.valorAtual || '0');
        const fimAtualStr = form?.dataset?.fimAtual || ''; 

        function show(el, on){ if (el) el.style.display = on ? 'block' : 'none'; }
        function req(el, on){ if (el){ el.required = !!on; el.setAttribute('aria-required', on ? 'true' : 'false'); } }

        function atualizarAjudaValor(tipo){
            let msg = '';
            switch (tipo) {
                case T.Supressao:       msg = 'O valor será SUBTRAÍDO do total vigente.'; break;
                case T.Acrescimo:       msg = 'O valor será ACRESCENTADO ao total vigente.'; break;
                case T.PrazoSupressao:  msg = 'O valor será SUBTRAÍDO e o prazo alterado.'; break;
                case T.PrazoAcrescimo:  msg = 'O valor será ACRESCENTADO e o prazo alterado.'; break;
                default: msg = '';
            }
            ajudaValor.textContent = msg;
            flagAuto?.classList.toggle('d-none', !msg);
        }

        function parsePtBr(s){
            if(!s) return 0;
            if (/^-?\d+(\.\d+)?$/.test(s)) return parseFloat(s);
            return Number((s || '').replace(/\./g,'').replace(',','.')) || 0;
        }
        
        function fmtBr(n){
            try { return Number(n).toLocaleString('pt-BR', { style:'currency', currency:'BRL' }); }
            catch { return 'R$ ' + (n || 0).toFixed(2); }
        }

        function mesesEntre(d1Str, d2Str) {
            if(!d1Str || !d2Str) return 0;
            const i = new Date(d1Str + 'T00:00:00');
            const f = new Date(d2Str + 'T00:00:00');
            if (isNaN(i) || isNaN(f)) return 0;
            if (f < i) return 0;
            return (f.getFullYear() - i.getFullYear()) * 12 + (f.getMonth() - i.getMonth()) + 1;
        }

        function atualizarPreview(){
            preview.textContent = '';
            const tipo = parseInt(tipoSelect?.value || '0', 10);
            const precisaValor = [T.Acrescimo, T.Supressao, T.PrazoAcrescimo, T.PrazoSupressao].includes(tipo);
            if(!precisaValor || !inpValor) return;

            let delta = parsePtBr(inpValor.value);
            if (delta <= 0) return;

            if (chkMensal && chkMensal.checked) {
                const dataFinalConsiderada = (novaFim && novaFim.value) ? novaFim.value : fimAtualStr;
                const dataInicialConsiderada = (iniAditivo && iniAditivo.value) ? iniAditivo.value : new Date().toISOString().slice(0, 10);
                
                const meses = mesesEntre(dataInicialConsiderada, dataFinalConsiderada);
                
                if(meses > 0) {
                    const deltaTotal = delta * meses;
                    preview.innerHTML = `<small class='d-block mb-1'>Cálculo Mensal: ${fmtBr(delta)} x ${meses} meses = <strong>${fmtBr(deltaTotal)}</strong></small>`;
                    delta = deltaTotal;
                } else {
                    preview.innerHTML = `<small class='text-danger'>Não foi possível calcular os meses (verifique datas).</small>`;
                }
            }

            const final = (tipo === T.Supressao || tipo === T.PrazoSupressao)
                          ? (valorAtual - delta)
                          : (valorAtual + delta);

            preview.innerHTML += `Valor Total Vigente: <strong>${fmtBr(valorAtual)}</strong> <br> Novo Total Estimado: <strong>${fmtBr(final)}</strong>`;
        }

        function aplicarTipo() {
            const tipo = parseInt(tipoSelect?.value || '0', 10);

            const precisaValor    = [T.Acrescimo, T.Supressao, T.PrazoAcrescimo, T.PrazoSupressao].includes(tipo);
            const precisaVigencia = [T.Prazo, T.PrazoAcrescimo, T.PrazoSupressao].includes(tipo);

            show(campoValor, precisaValor);
            show(campoData,  precisaVigencia);
            show(campoObj,   false);

            req(inpValor, precisaValor);
            req(novaFim,  precisaVigencia);

            atualizarAjudaValor(tipo);
            atualizarPreview();
        }
        
        function formatarMoedaInput(el) {
            const v = parsePtBr(el.value);
            if(v) el.value = v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        if(inpValor) {
            inpValor.addEventListener('blur', () => formatarMoedaInput(inpValor));
            inpValor.addEventListener('input', atualizarPreview);
        }

        tipoSelect?.addEventListener('change', aplicarTipo);
        chkMensal?.addEventListener('change', atualizarPreview);
        iniAditivo?.addEventListener('change', atualizarPreview);
        novaFim?.addEventListener('change', atualizarPreview);
        
        aplicarTipo();

        const summary = document.getElementById("validationSummary");
        if (summary && summary.innerText.trim().length > 0) summary.classList.remove("d-none");

        form?.addEventListener('submit', async (e) => {
            if (window.jQuery && !$(form).valid()) return;

            if (campoValor && campoValor.style.display !== 'none' && inpValor) {
                const clean = (inpValor.value || '').replace(/\./g, '').replace(',', '.');
                if (!clean || isNaN(clean) || Number(clean) <= 0) {
                    e.preventDefault();
                    return Swal.fire({ icon:'warning', title:'Informe um valor numérico maior que zero.' });
                }
                // Mantém a limpeza do valor para garantir formato numérico limpo
                // Mesmo usando ViewModel String, enviar com ponto facilita o parse do fallback
                inpValor.value = clean; 
            }

            e.preventDefault();
            const ok = await Swal.fire({
                icon:'question',
                title:'Confirmar registro do aditivo?',
                showCancelButton:true,
                confirmButtonText:'Salvar',
                cancelButtonText:'Cancelar'
            });
            if (ok.isConfirmed) form.submit();
        });

        // --- EXIBIÇÃO DE ALERTAS (TEMP DATA) ---
        const pageFlags = document.getElementById('pageFlags');
        if (pageFlags) {
            const successMsg = pageFlags.getAttribute('data-success');
            const errorMsg   = pageFlags.getAttribute('data-error');

            if (successMsg) {
                Swal.fire({
                    icon: 'success',
                    title: 'Sucesso!',
                    text: successMsg,
                    timer: 3000,
                    showConfirmButton: false
                });
            }

            if (errorMsg) {
                Swal.fire({
                    icon: 'error',
                    title: 'Atenção',
                    html: errorMsg // Permite quebras de linha do validation summary
                });
            }
        }
    });
    </script>
}