@model Financeiro.Models.ViewModels.AditivoContratoViewModel
@using Financeiro.Models
@{
    ViewData["Title"] = "Novo Aditivo de Contrato";
    var versaoAtual = ViewBag.VersaoAtual as ContratoVersao;
}

<h3>@ViewData["Title"]</h3>
<p>
    Adicionando aditivo ao contrato <strong>@versaoAtual?.ContratoId</strong> - Versão Atual: <strong>@versaoAtual?.Versao</strong>
</p>
<hr />

<div class="row">
    <div class="col-md-6">
        <h4>Dados Atuais</h4>
        <dl class="row">
            <dt class="col-sm-5">Valor Atual:</dt>
            <dd class="col-sm-7">@versaoAtual?.ValorContrato.ToString("C")</dd>

            <dt class="col-sm-5">Vigência Atual:</dt>
            <dd class="col-sm-7">@versaoAtual?.DataInicio.ToShortDateString() a @versaoAtual?.DataFim.ToShortDateString()</dd>

            <dt class="col-sm-5">Objeto Atual:</dt>
            <dd class="col-sm-7">@versaoAtual?.ObjetoContrato</dd>
        </dl>
    </div>
    <div class="col-md-6">
        <h4>Novo Aditivo</h4>
        <form asp-action="Salvar" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
            <input type="hidden" asp-for="ContratoId" />

            <div class="mb-3">
                <label asp-for="TipoAditivo" class="form-label"></label>
                <select asp-for="TipoAditivo" asp-items="Html.GetEnumSelectList<TipoAditivo>()" class="form-select" id="tipoAditivoSelect">
                    <option value="">Selecione o tipo...</option>
                </select>
                <span asp-validation-for="TipoAditivo" class="text-danger"></span>
            </div>

            <!-- ✅ NOVO: Campo para a Data de Início do Aditivo -->
            <div class="mb-3">
                <label asp-for="DataInicioAditivo" class="form-label"></label>
                <input asp-for="DataInicioAditivo" class="form-control" type="date" />
                <span asp-validation-for="DataInicioAditivo" class="text-danger"></span>
            </div>

            <div class="mb-3" id="campo-novo-valor" style="display: none;">
                <label asp-for="NovoValor" class="form-label"></label>
                <input asp-for="NovoValor" class="form-control" type="number" step="0.01" />
                <span asp-validation-for="NovoValor" class="text-danger"></span>
            </div>

            <div class="mb-3" id="campo-nova-data" style="display: none;">
                <label asp-for="NovaDataFim" class="form-label"></label>
                <input asp-for="NovaDataFim" class="form-control" type="date" />
                <span asp-validation-for="NovaDataFim" class="text-danger"></span>
            </div>
            
            <div class="mb-3" id="campo-novo-objeto" style="display: none;">
                <label asp-for="NovoObjeto" class="form-label"></label>
                <textarea asp-for="NovoObjeto" class="form-control" rows="3"></textarea>
                <span asp-validation-for="NovoObjeto" class="text-danger"></span>
            </div>

            <div class="mb-3">
                <label asp-for="Observacao" class="form-label"></label>
                <textarea asp-for="Observacao" class="form-control" rows="2"></textarea>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Salvar Aditivo</button>
                <a asp-controller="Contratos" asp-action="Editar" asp-route-id="@Model.ContratoId" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tipoAditivoSelect = document.getElementById('tipoAditivoSelect');
            
            const campoNovoValor = document.getElementById('campo-novo-valor');
            const campoNovaData = document.getElementById('campo-nova-data');
            const campoNovoObjeto = document.getElementById('campo-novo-objeto');

            function toggleCampos() {
                const tipo = tipoAditivoSelect.value;
                
                const Prazo = '1';
                const PrazoAcrescimo = '2';
                const PrazoSupressao = '3';
                const Supressao = '4';
                const Acrescimo = '5';

                const mostraValor = [Acrescimo, Supressao, PrazoAcrescimo, PrazoSupressao].includes(tipo);
                const mostraPrazo = [Prazo, PrazoAcrescimo, PrazoSupressao].includes(tipo);

                campoNovoValor.style.display = mostraValor ? 'block' : 'none';
                campoNovaData.style.display = mostraPrazo ? 'block' : 'none';
                campoNovoObjeto.style.display = 'none'; 
            }

            tipoAditivoSelect.addEventListener('change', toggleCampos);
            toggleCampos();
        });
    </script>
}