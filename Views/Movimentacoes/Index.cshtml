@model IEnumerable<Financeiro.Models.MovimentacaoFinanceira>
@using System.Globalization

@{
    ViewData["Title"] = "Movimentações Financeiras";
    var ptBR = new CultureInfo("pt-BR");
}

<!-- Alertas SweetAlert -->
<div id="pageFlags"
     data-success="@TempData["Sucesso"]"
     data-error="@TempData["Erro"]"></div>

<div class="container-fluid px-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold mb-1"><i class="bx bx-money-withdraw me-2"></i>@ViewData["Title"]</h3>
            <p class="text-muted mb-0">Histórico de pagamentos e lançamentos</p>
        </div>
        <a asp-action="Novo" class="btn btn-primary">
            <i class="bx bx-plus me-1"></i> Novo Pagamento
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Data</th>
                            <th>Fornecedor / Beneficiário</th>
                            <th>Histórico</th>
                            <th class="text-end">Valor</th>
                            <th class="text-center pe-4">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model == null || !Model.Any())
                        {
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="bx bx-ghost fs-1 mb-2 d-block"></i>
                                    Nenhum lançamento encontrado.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var item in Model)
                            {
                                // Verifica se é um estorno (valor negativo ou texto no histórico)
                                bool ehEstorno = item.ValorTotal < 0 || (item.Historico?.Contains("[ESTORNO]") ?? false);
                                string classeValor = item.ValorTotal < 0 ? "text-success" : "text-danger"; // Saída vermelho, Entrada/Estorno verde

                                <tr class="@(ehEstorno ? "bg-light text-muted" : "")">
                                    <td class="ps-4 text-nowrap">
                                        <div class="fw-semibold">@item.DataMovimentacao.ToString("dd/MM/yyyy")</div>
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(item.FornecedorIdCompleto))
                                        {
                                            <span class="badge bg-info-subtle text-info border border-info-subtle">
                                                <i class="bx bx-user me-1"></i> @item.FornecedorIdCompleto
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if(ehEstorno) { <span class="badge bg-warning text-dark me-1">ESTORNO</span> }
                                        @item.Historico
                                    </td>
                                    <td class="text-end">
                                        <span class="fw-bold @classeValor fs-6">
                                            @item.ValorTotal.ToString("C", ptBR)
                                        </span>
                                    </td>
                                    <td class="text-center pe-4">
                                        @if(!ehEstorno) // Só permite estornar o que não é estorno
                                        {
                                            <button class="btn btn-sm btn-outline-danger js-estornar" 
                                                    data-id="@item.Id" 
                                                    title="Estornar Lançamento">
                                                <i class="bx bx-undo"></i> Estornar
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            // Alertas de Carga de Página
            const pageFlags = document.getElementById('pageFlags');
            if (pageFlags) {
                const success = pageFlags.dataset.success;
                const error = pageFlags.dataset.error;
                if (success) Swal.fire({ icon: 'success', title: 'Sucesso', text: success });
                if (error) Swal.fire({ icon: 'error', title: 'Erro', html: error });
            }

            // Botão de Estornar
            $('.js-estornar').click(async function() {
                const id = $(this).data('id');
                
                const { value: justificativa } = await Swal.fire({
                    title: 'Confirmar Estorno?',
                    text: "Isso criará um lançamento reverso. O valor voltará ao saldo.",
                    icon: 'warning',
                    input: 'textarea',
                    inputLabel: 'Motivo do Estorno',
                    inputPlaceholder: 'Ex: Lançamento duplicado...',
                    inputValidator: (value) => {
                        if (!value) return 'Você precisa escrever uma justificativa!'
                    },
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sim, estornar!'
                });

                if (justificativa) {
                    try {
                        const formData = new FormData();
                        formData.append('id', id);
                        formData.append('justificativa', justificativa);

                        const response = await fetch('@Url.Action("Estornar", "Movimentacoes")', {
                            method: 'POST',
                            body: formData // Envia como Form Data simples
                        });

                        if (response.ok) {
                            await Swal.fire('Estornado!', 'O lançamento foi compensado.', 'success');
                            window.location.reload();
                        } else {
                            Swal.fire('Erro', 'Não foi possível realizar o estorno.', 'error');
                        }
                    } catch (e) {
                        Swal.fire('Erro', 'Falha na comunicação.', 'error');
                    }
                }
            });
        });
    </script>
}