@model IEnumerable<Financeiro.Models.ViewModels.FornecedorViewModel>
@using Financeiro.Extensions 

@{
    ViewData["Title"] = "Fornecedores";
    Layout = "_Layout";

    // Permissões
    bool podeCriar  = User.TemPermissao("FORNECEDOR_ADD");
    bool podeEditar = User.TemPermissao("FORNECEDOR_EDIT");
    bool podeExcluir= User.TemPermissao("FORNECEDOR_DEL");

    // Paginação e Busca
    int paginaAtual  = ViewBag.PaginaAtual ?? 1;
    int totalPaginas = ViewBag.TotalPaginas ?? 1;
    string buscaAtual = ViewBag.BuscaAtual ?? "";
}

@functions {
    string FormatCnpj(string? cnpj) {
        if (string.IsNullOrWhiteSpace(cnpj)) return "";
        var d = new string(cnpj.Where(char.IsDigit).ToArray());
        return d.Length != 14 ? cnpj : $"{d[..2]}.{d.Substring(2, 3)}.{d.Substring(5, 3)}/{d.Substring(8, 4)}-{d.Substring(12, 2)}";
    }
    string FormatCpf(string? cpf) {
        if (string.IsNullOrWhiteSpace(cpf)) return "";
        var d = new string(cpf.Where(char.IsDigit).ToArray());
        return d.Length != 11 ? cpf : $"{d[..3]}.{d.Substring(3, 3)}.{d.Substring(6, 3)}-{d.Substring(9, 2)}";
    }
    string FormatPhoneBr(string? phone) {
        if (string.IsNullOrWhiteSpace(phone)) return "";
        var d = new string(phone.Where(char.IsDigit).ToArray());
        if (d.Length == 10) return $"({d[..2]}) {d.Substring(2, 4)}-{d.Substring(6, 4)}";
        if (d.Length == 11) return $"({d[..2]}) {d.Substring(2, 5)}-{d.Substring(7, 4)}";
        return phone;
    }
}

<style>
    .fornecedor-card { transition: transform .06s ease, box-shadow .06s ease; }
    .fornecedor-card:hover { transform: translateY(-1px); box-shadow: 0 .25rem .75rem rgba(16, 36, 68, .08); }
    .pj-card { border-left: 4px solid var(--blue); }
    .pf-card { border-left: 4px solid var(--cyan); }
    
    .doc-number { font-variant-numeric: tabular-nums; letter-spacing: .2px; }
    
    /* Paginação */
    .pagination .page-link {
        border: none; color: #6c757d; border-radius: 50%; width: 40px; height: 40px;
        display: flex; align-items: center; justify-content: center; margin: 0 5px; transition: all 0.2s;
    }
    .pagination .page-link:hover:not(.disabled) { background-color: #e9ecef; color: #0d6efd; }
    .pagination .page-item.disabled .page-link { background-color: transparent; color: #dee2e6; }
    .pagination .page-info { display: flex; align-items: center; font-size: 0.9rem; color: #6c757d; font-weight: 600; margin: 0 15px; }
</style>

<div class="d-flex flex-wrap align-items-center justify-content-between mb-4 gap-3">
    <div>
        <h2 class="mb-0 fw-bold text-dark">
            <i class="bx bx-briefcase-alt-2 me-2"></i> Fornecedores
        </h2>
        <small class="text-muted">Gestão unificada de PF e PJ</small>
    </div>

    <div class="d-flex gap-2">
        <form method="get" class="d-flex shadow-sm rounded-pill bg-white border ps-3 p-1">
            <input type="text" name="busca" value="@buscaAtual" class="form-control border-0 shadow-none bg-transparent" placeholder="Buscar..." aria-label="Buscar">
            <button class="btn btn-link text-primary" type="submit"><i class="bx bx-search"></i></button>
            @if (!string.IsNullOrEmpty(buscaAtual))
            {
                <a asp-action="Index" class="btn btn-link text-danger"><i class="bx bx-x"></i></a>
            }
        </form>

        @if (podeCriar)
        {
            <div class="dropdown">
                <button class="btn btn-primary rounded-pill px-4 shadow-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bx bx-plus-circle me-1"></i> Novo
                </button>
                <ul class="dropdown-menu shadow border-0">
                    <li>
                        <a class="dropdown-item py-2" asp-controller="PessoasFisicas" asp-action="Novo">
                            <i class="bx bx-user me-2 text-primary"></i>Pessoa Física
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item py-2" asp-controller="PessoasJuridicas" asp-action="Novo">
                            <i class="bx bx-building me-2 text-success"></i>Pessoa Jurídica
                        </a>
                    </li>
                </ul>
            </div>
        }
    </div>
</div>

@if (!Model.Any())
{
    <div class="col-12">
        <div class="text-center py-5 bg-white rounded-3 shadow-sm border border-dashed">
            <i class="bx bx-user-pin display-4 text-light mb-3"></i>
            <h5 class="text-muted">Nenhum fornecedor encontrado</h5>
            @if (!string.IsNullOrEmpty(buscaAtual))
            {
                <p class="small text-muted">Tente refazer a busca com outros termos.</p>
            }
        </div>
    </div>
}
else
{
    <div class="row g-3 row-cols-1 row-cols-md-2 row-cols-xl-3">
        @foreach (var item in Model)
        {
            var controllerDestino = item.TipoPessoa == "PF" ? "PessoasFisicas" : "PessoasJuridicas";
            var cardClass = item.TipoPessoa == "PF" ? "pf-card" : "pj-card";
            var docFormatado = item.TipoPessoa == "PF" ? FormatCpf(item.Documento) : FormatCnpj(item.Documento);
            var icone = item.TipoPessoa == "PF" ? "bx-user" : "bx-building";
            var badgeColor = item.TipoPessoa == "PF" ? "bg-info text-dark" : "bg-primary";

            <div class="col">
                <div class="card h-100 shadow-sm border-0 fornecedor-card @cardClass">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <span class="badge @badgeColor mb-1"><i class="bx @icone me-1"></i> @item.TipoPessoa</span>
                                <h5 class="card-title fw-bold text-dark mb-0 text-truncate" title="@item.Nome">
                                    @item.Nome
                                </h5>
                            </div>
                        </div>

                        <div class="small text-muted mb-3 doc-number">
                            <i class='bx bx-id-card me-1'></i> @docFormatado
                        </div>

                        <div class="small text-muted d-flex flex-column gap-1 mt-auto">
                            @if (!string.IsNullOrEmpty(item.Email))
                            {
                                <div class="text-truncate" title="@item.Email">
                                    <i class="bx bx-envelope me-2"></i> @item.Email
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(item.Telefone))
                            {
                                <div>
                                    <i class="bx bx-phone me-2"></i> @FormatPhoneBr(item.Telefone)
                                </div>
                            }
                        </div>
                    </div>

                    <div class="card-footer bg-transparent border-0 pt-3 pb-3">
                        <div class="d-flex justify-content-end gap-2">
                            @* Endereços e Contas são visualização/edição, então precisam de permissão de EDIT ou VIEW *@
                            <div class="btn-group">
                                <a class="btn btn-sm btn-outline-secondary" title="Endereços"
                                   asp-controller="Enderecos"
                                   asp-action="@(item.TipoPessoa == "PJ" ? "GerenciarPessoaJuridica" : "GerenciarPessoaFisica")"
                                   asp-route-pessoaJuridicaId="@(item.TipoPessoa == "PJ" ? item.Id : null)"
                                   asp-route-pessoaFisicaId="@(item.TipoPessoa == "PF" ? item.Id : null)">
                                    <i class='bx bx-map'></i>
                                </a>
                                <a class="btn btn-sm btn-outline-secondary" title="Contas Bancárias"
                                   asp-controller="ContasBancarias"
                                   asp-action="@(item.TipoPessoa == "PJ" ? "IndexPJ" : "IndexPF")"
                                   asp-route-pessoaId="@item.Id">
                                    <i class='bx bx-credit-card'></i> @* <--- ÍCONE ALTERADO AQUI *@
                                </a>
                            </div>

                            @if (podeEditar)
                            {
                                <a asp-controller="@controllerDestino" asp-action="Editar" asp-route-id="@item.Id" 
                                   class="btn btn-sm btn-outline-primary" title="Editar">
                                    <i class="bx bx-pencil"></i>
                                </a>
                            }

                            @if (podeExcluir)
                            {
                                <form asp-controller="@controllerDestino" 
                                      asp-action="Excluir" 
                                      asp-route-id="@item.Id" 
                                      method="post" 
                                      class="d-inline js-delete-form"
                                      data-nome="@item.Nome"
                                      data-tipo="@item.TipoPessoa">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir">
                                        <i class="bx bx-trash"></i>
                                    </button>
                                </form>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (totalPaginas > 1)
    {
        <div class="d-flex justify-content-center mt-5 mb-3">
            <nav>
                <ul class="pagination align-items-center shadow-sm bg-white rounded-pill p-1">
                    <li class="page-item @(paginaAtual == 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-pagina="@(paginaAtual - 1)" asp-route-busca="@buscaAtual" aria-label="Anterior">
                            <i class="bx bx-chevron-left"></i>
                        </a>
                    </li>
                    <li class="page-item disabled">
                        <span class="page-info">Página @paginaAtual de @totalPaginas</span>
                    </li>
                    <li class="page-item @(paginaAtual == totalPaginas ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-pagina="@(paginaAtual + 1)" asp-route-busca="@buscaAtual" aria-label="Próximo">
                            <i class="bx bx-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>
    }
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hasSwal = typeof window.Swal !== 'undefined';
            
            // Feedback do TempData
            const msgSucesso = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["Sucesso"]));
            const msgErro    = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["Erro"]));

            if (msgSucesso) Swal.fire({ icon:'success', title:'Sucesso', text: msgSucesso, timer: 3000, showConfirmButton: false });
            if (msgErro)    Swal.fire({ icon:'error',   title:'Atenção', text: msgErro });

            // Lógica de Exclusão
            document.querySelectorAll('.js-delete-form').forEach(form => {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const nome = this.dataset.nome;
                    const tipo = this.dataset.tipo; 
                    
                    const title = tipo === 'PJ' ? "Excluir Pessoa Jurídica?" : "Excluir Pessoa Física?";
                    const text = `Tem certeza que deseja excluir <strong>${nome}</strong>?<br>Esta ação não poderá ser desfeita.`;

                    if (hasSwal) {
                        Swal.fire({
                            title: title,
                            html: text,
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#dc3545',
                            cancelButtonColor: '#6c757d',
                            confirmButtonText: 'Sim, excluir',
                            cancelButtonText: 'Cancelar'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                this.submit();
                            }
                        });
                    } else if (confirm(`Excluir ${nome}?`)) {
                        this.submit();
                    }
                });
            });
        });
    </script>
}