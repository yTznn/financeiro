@model Financeiro.Models.ViewModels.ContratoViewModel
@using System.Globalization
@using Financeiro.Extensions 

@{
    ViewBag.Title = Model.Id == 0 ? "Novo Contrato" : "Editar Contrato";
    Layout = "_Layout";
    
    var versaoAtual = ViewBag.VersaoAtual as Financeiro.Models.ContratoVersao;
    var controllerAction = Model.Id == 0 ? "Salvar" : "Atualizar"; 
    bool isEdicao = Model.Id > 0;
    var br = new CultureInfo("pt-BR");

    // Lógica para saber se tem aditivo (Versão > 1)
    bool temAditivo = versaoAtual != null && versaoAtual.Versao > 1;

    // Valor original (fallback para o valor do model se não vier na viewbag)
    decimal valorOriginal = ViewBag.ValorOriginal != null ? (decimal)ViewBag.ValorOriginal : Model.ValorContrato;
    
    // Permissões
    bool podeAditivar = isEdicao && User.TemPermissao("ADITIVO_ADD");
    bool podeEditar   = isEdicao ? User.TemPermissao("CONTRATO_EDIT") : User.TemPermissao("CONTRATO_ADD");
    bool podeCancelar = isEdicao && temAditivo && User.TemPermissao("ADITIVO_DEL");
}

@* --- FLAG PARA O SWEETALERT --- *@
<div id="pageFlags"
     data-success="@(TempData["MensagemSucesso"] ?? TempData["Sucesso"])"
     data-error="@(TempData["MensagemErro"] ?? TempData["Erro"])"></div>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>@ViewBag.Title</h2>
</div>

@if (isEdicao)
{
  <div class="mb-3 d-flex flex-wrap gap-2">
    @if (podeAditivar) {
        <a asp-controller="AditivosContrato" asp-action="Novo" asp-route-contratoId="@Model.Id" class="btn btn-outline-primary">
          <i class="bi bi-file-earmark-plus"></i> Registrar Aditivo
        </a>
    }
    <button type="button" class="btn btn-outline-secondary" onclick="carregarHistorico(@Model.Id)">
      <i class="bi bi-clock-history"></i> Histórico
    </button>
    @if (podeCancelar) {
      <button type="button" class="btn btn-outline-danger" id="btnCancelarAditivo"
              data-contrato="@Model.Id" data-versao="@versaoAtual.Versao">
        <i class="bi bi-x-circle"></i> Cancelar último aditivo
      </button>
    }
  </div>
}

<div asp-validation-summary="All" class="alert alert-danger d-none" id="validationSummary"></div>

<form id="formContrato" asp-controller="Contratos" asp-action="@controllerAction" method="post" class="row g-3 needs-validation" novalidate>
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    
    @* --- BLOCO 1: DADOS GERAIS --- *@
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light fw-bold">Dados do Contrato</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label asp-for="FornecedorIdCompleto" class="form-label">Fornecedor</label>
                        <select asp-for="FornecedorIdCompleto" class="form-select" id="FornecedorSelect" style="width: 100%;">
                            @if (ViewBag.FornecedorAtual != null) {
                                var f = (Financeiro.Models.VwFornecedor)ViewBag.FornecedorAtual;
                                <option value="@Model.FornecedorIdCompleto" selected>@f.Nome (@f.Documento)</option>
                            }
                        </select>
                    </div>
                    
                    @* --- LINHA DOS ORÇAMENTOS (MACRO E DETALHE) --- *@
                    <div class="col-md-3">
                        <label asp-for="OrcamentoId" class="form-label">Orçamento (Macro)</label>
                        <select asp-for="OrcamentoId" class="form-select" id="OrcamentoId" asp-items="@(new SelectList(ViewBag.Orcamentos, "Id", "Nome", Model.OrcamentoId))">
                            <option value="">-- Selecione --</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="OrcamentoDetalheId" class="form-label">Item do Orçamento</label>
                        <select asp-for="OrcamentoDetalheId" class="form-select" id="OrcamentoDetalheId" 
                                asp-items="@(ViewBag.ItensOrcamento != null ? ViewBag.ItensOrcamento : new List<SelectListItem>())">
                            <option value="">-- Selecione o Macro primeiro --</option>
                        </select>
                        <div class="invalid-feedback">Obrigatório selecionar o item específico.</div>
                    </div>
                    @* --------------------------------------------- *@

                    <div class="col-md-3">
                        <label asp-for="NumeroContrato" class="form-label">Número</label>
                        <div class="input-group">
                            <input asp-for="NumeroContrato" type="number" class="form-control" id="NumeroContrato" />
                            <button class="btn btn-outline-secondary" type="button" id="btnSugerirNumero"><i class="bi bi-magic"></i></button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="AnoContrato" class="form-label">Ano</label>
                        <input asp-for="AnoContrato" type="number" class="form-control" id="AnoContrato" value="@(Model.AnoContrato == 0 ? DateTime.Now.Year : Model.AnoContrato)" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ObjetoContrato" class="form-label">Objeto</label>
                        <textarea asp-for="ObjetoContrato" class="form-control" rows="1"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* --- BLOCO 2: DADOS ORIGINAIS (SÓ APARECE SE TIVER ADITIVO) --- *@
    @if (temAditivo)
    {
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-light">
                <div class="card-header bg-secondary text-white fw-bold d-flex justify-content-between">
                    <span><i class="bi bi-clock-history me-2"></i> Dados Originais (Versão 1)</span>
                    <span class="badge bg-light text-dark">Apenas Consulta</span>
                </div>
                <div class="card-body opacity-75">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Data Assinatura</label>
                            <input type="text" class="form-control" 
                                   value="@(Model.DataAssinatura.HasValue ? Model.DataAssinatura.Value.ToString("dd/MM/yyyy") : "")" 
                                   disabled />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Valor Original (R$)</label>
                            <input type="text" class="form-control fw-bold" value="@valorOriginal.ToString("N2", br)" disabled />
                        </div>
                        <div class="col-md-6 d-flex align-items-center">
                            <small class="text-muted">Estes eram os valores antes dos aditivos.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    @* --- BLOCO 3: VIGÊNCIA E VALORES (VIGENTES / ADITIVADOS) --- *@
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white fw-bold">
                @(temAditivo ? "Dados Vigentes (Atualizados via Aditivo)" : "Vigência e Valores")
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label asp-for="DataAssinatura" class="form-label">Data Assinatura</label>
                        <input asp-for="DataAssinatura" type="date" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="DataInicio" class="form-label">Data Início (Vigente)</label>
                        <input asp-for="DataInicio" type="date" class="form-control" id="DataInicio" />
                    </div>
                    <div class="col-md-3">
                        <label asp-for="DataFim" class="form-label">Data Fim (Vigente)</label>
                        <input asp-for="DataFim" type="date" class="form-control" id="DataFim" />
                    </div>
                    
                    <div class="col-md-3 d-flex align-items-center">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" asp-for="Ativo" id="AtivoSwitch">
                            <label class="form-check-label fw-bold" for="AtivoSwitch">Contrato Ativo</label>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <label asp-for="ValorMensal" class="form-label">Valor Mensal Vigente (R$)</label>
                        <input asp-for="ValorMensal" class="form-control money" id="ValorMensal" />
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Valor Total Vigente (R$)</label>
                        <input type="text" 
                               name="ValorContrato" 
                               id="ValorTotal"
                               class="form-control bg-light fw-bold text-primary" 
                               readonly 
                               tabindex="-1"
                               value="@Model.ValorContrato.ToString("N2", br)"
                               data-val="false" />
                        
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted" id="infoCalculo"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* --- BLOCO 4: RATEIO (VALIDAÇÃO) --- *@
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light fw-bold d-flex justify-content-between align-items-center">
                <span>Distribuição por Natureza (Rateio)</span>
                <span id="badgeRateio" class="badge bg-secondary">Total: R$ 0,00</span>
            </div>
            <div class="card-body">
                
                <div id="avisoRateio" class="alert alert-warning py-2 mb-3" style="display:none;">
                    <i class="bi bi-exclamation-circle-fill me-1"></i>
                    <strong>Atenção:</strong> Os valores vigentes mudaram. <br>
                    Você deve redistribuir o saldo nas naturezas abaixo para igualar o novo Valor Mensal.
                    <div id="msgDiferenca" class="small mt-1 fw-bold"></div>
                </div>

                <div class="row g-2 align-items-end mb-3 border-bottom pb-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">Selecionar Natureza</label>
                        <select id="selectNatureza" class="form-select">
                            <option value="">-- Selecione uma Natureza --</option>
                            @if (ViewBag.Naturezas != null) {
                                foreach (var nat in (IEnumerable<Financeiro.Models.Natureza>)ViewBag.Naturezas) {
                                    <option value="@nat.Id">@nat.Nome</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Valor Mensal (R$)</label>
                        <input type="text" id="inputValorNatureza" class="form-control money" placeholder="0,00" />
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-primary w-100" id="btnAddNatureza">
                            <i class="bi bi-plus-circle"></i> Adicionar
                        </button>
                    </div>
                </div>

                <table class="table table-hover mb-0" id="tabelaNaturezas">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60%">Natureza de Despesa</th>
                            <th style="width: 30%">Valor Mensal (R$)</th>
                            <th style="width: 10%" class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyNaturezas">
                        @if (Model.Naturezas != null) {
                            int i = 0;
                            foreach (var item in Model.Naturezas) {
                                string nomeNat = "Natureza ID " + item.NaturezaId; 
                                if (ViewBag.Naturezas != null) {
                                    var lista = (IEnumerable<Financeiro.Models.Natureza>)ViewBag.Naturezas;
                                    var obj = lista.FirstOrDefault(x => x.Id == item.NaturezaId);
                                    if(obj != null) nomeNat = obj.Nome;
                                }
                                <tr class="linha-natureza">
                                    <td>
                                        <input type="hidden" name="Naturezas[@i].NaturezaId" value="@item.NaturezaId" class="nat-id" />
                                        <input type="hidden" name="Naturezas[@i].NomeNatureza" value="@nomeNat" class="nat-nome-input" />
                                        <span class="nat-nome">@nomeNat</span>
                                    </td>
                                    <td>
                                        <input type="hidden" name="Naturezas[@i].Valor" value="@item.Valor.ToString("N2", br)" class="nat-valor-raw" />
                                        <span class="nat-valor-display">@item.Valor.ToString("N2", br)</span>
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-nat"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                                i++;
                            }
                        }
                    </tbody>
                </table>
                <div class="text-center p-3 text-muted" id="msgSemNaturezas" style="@(Model.Naturezas != null && Model.Naturezas.Any() ? "display:none" : "")">
                    Nenhuma natureza adicionada.
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <label asp-for="Observacao" class="form-label">Observações</label>
        <textarea asp-for="Observacao" class="form-control" rows="2"></textarea>
    </div>

    <div class="col-12 d-flex gap-2 mt-4 pt-3 border-top">
        @if (podeEditar) {
            <button type="submit" class="btn btn-success px-4" id="btnSalvar">
                <i class="bi bi-check-lg me-1"></i> @(Model.Id == 0 ? "Salvar Contrato" : "Salvar Alterações Cadastrais")
            </button>
        }
        else {
            <div class="alert alert-warning mb-0"><i class="bi bi-lock-fill"></i> Sem permissão de edição.</div>
        }
        <a asp-action="Index" class="btn btn-light border px-4">Cancelar / Voltar</a>
    </div>
</form>

@* --- MODAL DE HISTÓRICO --- *@
<div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Histórico de Aditivos</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="histBody">
          <div class="text-center my-3"><div class="spinner-border"></div></div>
        </div>
      </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
    
    <script>
        var formChanged = false;
        var rateioValido = false; 

        function carregarHistorico(id) {
            var modal = new bootstrap.Modal(document.getElementById('modalHistorico'));
            modal.show();
            $('#histBody').load('@Url.Action("Historico", "Contratos")?id=' + id);
        }

        $(document).ready(function() {
            $('.money').mask('#.##0,00', {reverse: true});

            // --- LÓGICA DO DROPDOWN EM CASCATA (AJAX) ---
            $('#OrcamentoId').change(function() {
                var orcamentoId = $(this).val();
                var $comboDetalhe = $('#OrcamentoDetalheId');
                
                // Limpa e mostra estado carregando
                $comboDetalhe.empty().append('<option value="">Carregando...</option>').prop('disabled', true);

                if (orcamentoId) {
                    $.getJSON('@Url.Action("ListarItensOrcamento", "Contratos")', { orcamentoId: orcamentoId })
                        .done(function(data) {
                            $comboDetalhe.empty().append('<option value="">-- Selecione o Item --</option>');
                            if (data.length > 0) {
                                $.each(data, function(i, item) {
                                    $comboDetalhe.append($('<option>', { value: item.id, text: item.nome }));
                                });
                                $comboDetalhe.prop('disabled', false);
                            } else {
                                $comboDetalhe.append('<option value="">Nenhum item disponível para lançamento</option>');
                            }
                        })
                        .fail(function() {
                            $comboDetalhe.empty().append('<option value="">Erro ao carregar</option>');
                        });
                } else {
                    $comboDetalhe.empty().append('<option value="">-- Selecione o Macro primeiro --</option>').prop('disabled', true);
                }
            });
            // --------------------------------------------------

            $('form input, form select, form textarea').on('change input', function() {
                if (!$(this).prop('readonly')) {
                    formChanged = true;
                }
            });

            function brlToFloat(str) {
                if (!str) return 0;
                return parseFloat(str.replace(/\./g, '').replace(',', '.'));
            }

            function floatToBrl(val) {
                if (isNaN(val)) return '0,00';
                return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // Select2
            $('#FornecedorSelect').select2({
                theme: 'bootstrap-5',
                placeholder: 'Busque por nome ou documento...',
                allowClear: true,
                width: '100%', 
                minimumInputLength: 2,
                ajax: {
                    url: '@Url.Action("BuscarFornecedores", "Contratos")',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) { return { term: params.term, page: params.page || 1 }; },
                    processResults: function (data, params) { return { results: data.results, pagination: { more: data.pagination.more } }; },
                    cache: true
                }
            });

            $('#btnSugerirNumero').click(function() {
                var ano = $('#AnoContrato').val();
                if(!ano) { Swal.fire('Atenção', 'Informe o ano primeiro.', 'warning'); return; }
                $.get('@Url.Action("SugerirNumero", "Contratos")?ano=' + ano, function(data) {
                    $('#NumeroContrato').val(data.proximoNumero);
                });
            });

            // --- LÓGICA DE DATAS E TOTAIS ---
            function getMesesEntre(d1Str, d2Str) {
                if (!d1Str || !d2Str) return 1;
                var inicio = new Date(d1Str + "T12:00:00");
                var fim = new Date(d2Str + "T12:00:00");
                var meses = (fim.getFullYear() - inicio.getFullYear()) * 12;
                meses -= inicio.getMonth();
                meses += fim.getMonth();
                meses += 1; 
                if (meses <= 0) meses = 1;
                return meses;
            }

            function recalcularMensalPeloTotal() {
                var totalVigente = brlToFloat($('#ValorTotal').val());
                var dIni = $('#DataInicio').val();
                var dFim = $('#DataFim').val();
                
                if (totalVigente > 0 && dIni && dFim) {
                    var meses = getMesesEntre(dIni, dFim);
                    var mensal = totalVigente / meses;
                    $('#ValorMensal').val(floatToBrl(mensal));
                    $('#infoCalculo').text(`Recalculado: Total ${floatToBrl(totalVigente)} ÷ ${meses} meses = ${floatToBrl(mensal)}`);
                }
            }

            function calcularTotalPeloMensal() {
                var dIni = $('#DataInicio').val();
                var dFim = $('#DataFim').val();
                var valMensal = brlToFloat($('#ValorMensal').val());

                if (dIni && dFim && valMensal >= 0) {
                    var meses = getMesesEntre(dIni, dFim);
                    var total = valMensal * meses;
                    $('#ValorTotal').val(floatToBrl(total));
                    $('#infoCalculo').text(`Cálculo: ${meses} meses x R$ ${floatToBrl(valMensal)}`);
                }
            }

            // --- VALIDAÇÃO DE RATEIO ---
            function atualizarRateio() {
                var totalNaturezas = 0;
                var count = 0;
                
                $('#tbodyNaturezas .nat-valor-raw').each(function() {
                    totalNaturezas += brlToFloat($(this).val());
                    count++;
                });

                if(count === 0) $('#msgSemNaturezas').show(); else $('#msgSemNaturezas').hide();

                var valMensalEsperado = brlToFloat($('#ValorMensal').val());
                var diff = totalNaturezas - valMensalEsperado;
                var diffAbs = Math.abs(diff);
                
                var badge = $('#badgeRateio');
                var aviso = $('#avisoRateio');
                var msgDiff = $('#msgDiferenca');
                var btnSalvar = $('#btnSalvar');

                if (diffAbs < 0.05) { 
                    rateioValido = true;
                    badge.text("Total Rateio: " + floatToBrl(totalNaturezas)).attr('class', 'badge bg-success');
                    aviso.hide();

                    if(btnSalvar.hasClass('btn-danger')) {
                        btnSalvar.html('<i class="bi bi-check-lg me-1"></i> Salvar Alterações Cadastrais');
                        btnSalvar.removeClass('btn-danger').addClass('btn-success');
                    }
                }
                else {
                    rateioValido = false;
                    aviso.show();
                    
                    btnSalvar.html('<i class="bi bi-exclamation-octagon-fill me-1"></i> Refaça o Rateio para Salvar');
                    btnSalvar.removeClass('btn-success btn-warning').addClass('btn-danger');

                    if (diff > 0) { 
                        badge.attr('class', 'badge bg-danger');
                        msgDiff.html(`O total distribuído excede o valor mensal em <strong>R$ ${floatToBrl(diffAbs)}</strong>.`);
                    }
                    else { 
                        badge.attr('class', 'badge bg-warning text-dark');
                        msgDiff.html(`Valor mensal aumentou (Aditivo).<br>Falta distribuir <strong>R$ ${floatToBrl(diffAbs)}</strong>.`);
                    }
                    $('#badgeRateio').text("Total Rateio: " + floatToBrl(totalNaturezas));
                }
            }

            // Ações Tabela Natureza
            $('#btnAddNatureza').click(function() {
                var id = $('#selectNatureza').val();
                var texto = $('#selectNatureza option:selected').text();
                var valorStr = $('#inputValorNatureza').val(); 

                if (!id || !valorStr) { Swal.fire('Atenção', 'Preencha natureza e valor.', 'warning'); return; }

                var existe = false;
                $('.nat-id').each(function() { if ($(this).val() == id) existe = true; });
                if (existe) { Swal.fire('Atenção', 'Esta natureza já foi adicionada.', 'warning'); return; }

                var tr = `<tr class="linha-natureza">
                        <td><input type="hidden" name="Naturezas[0].NaturezaId" value="${id}" class="nat-id" />
                            <input type="hidden" name="Naturezas[0].NomeNatureza" value="${texto}" class="nat-nome-input" />
                            <span class="nat-nome">${texto}</span></td>
                        <td><input type="hidden" name="Naturezas[0].Valor" value="${valorStr}" class="nat-valor-raw" />
                            <span class="nat-valor-display">${valorStr}</span></td>
                        <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-remove-nat"><i class="bi bi-trash"></i></button></td>
                    </tr>`;
                
                $('#tbodyNaturezas').append(tr);
                $('#selectNatureza').val('');
                $('#inputValorNatureza').val('');
                reindexarNaturezas();
                formChanged = true;
                atualizarRateio();
            });

            $(document).on('click', '.btn-remove-nat', function() {
                $(this).closest('tr').remove();
                reindexarNaturezas();
                formChanged = true;
                atualizarRateio();
            });

            function reindexarNaturezas() {
                $('#tbodyNaturezas tr').each(function(index) {
                    $(this).find('input.nat-id').attr('name', `Naturezas[${index}].NaturezaId`);
                    $(this).find('input.nat-nome-input').attr('name', `Naturezas[${index}].NomeNatureza`);
                    $(this).find('input.nat-valor-raw').attr('name', `Naturezas[${index}].Valor`);
                });
            }

            $('#DataInicio, #DataFim').on('change', function() {
                recalcularMensalPeloTotal();
                atualizarRateio();
                formChanged = true;
            });

            $('#ValorMensal').on('keyup', function() {
                calcularTotalPeloMensal();
                atualizarRateio();
                formChanged = true;
            });

            recalcularMensalPeloTotal();
            
            setTimeout(atualizarRateio, 200);

            $('#formContrato').on('submit', async function(e) {
                var isEdicao = '@isEdicao';
                
                if (!$('#FornecedorSelect').val()) {
                    Swal.fire('Atenção', 'Selecione um fornecedor.', 'warning');
                    e.preventDefault(); return;
                }

                if (rateioValido === false) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Pendência Financeira',
                        html: 'O valor do contrato mudou (Aditivo) e a distribuição das naturezas está desatualizada.<br><br><b>Ajuste a tabela de rateio para igualar o novo valor mensal.</b>'
                    });
                    e.preventDefault();
                    return;
                }

                if (isEdicao === 'False') {
                    if (!this.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
                    this.classList.add('was-validated');
                    return; 
                }

                e.preventDefault();
                if (!this.checkValidity()) { this.classList.add('was-validated'); return; }

                if (formChanged === false) {
                    this.submit();
                    return;
                }

                const { value: justif } = await Swal.fire({
                    title: 'Salvar Alterações',
                    input: 'textarea',
                    inputLabel: 'Justificativa da alteração',
                    inputValidator: (value) => { if (!value) return 'Obrigatório!' },
                    showCancelButton: true,
                    confirmButtonText: 'Salvar'
                });

                if (justif) {
                    $('<input>').attr({type: 'hidden', name: 'justificativa', value: justif}).appendTo('#formContrato');
                    this.submit();
                }
            });

            $('#btnCancelarAditivo').click(async function() {
                const contratoId = $(this).data('contrato');
                const versao = $(this).data('versao');
                const { value: justif } = await Swal.fire({
                    title: 'Cancelar Aditivo?',
                    html: `Reverter para versão anterior? (V.${versao} será excluída)`,
                    icon: 'warning',
                    input: 'textarea',
                    inputLabel: 'Justificativa',
                    inputValidator: (value) => { if (!value) return 'Obrigatório.' },
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Sim, cancelar'
                });

                if (justif) {
                    $.post('@Url.Action("CancelarUltimoAditivo", "Contratos")', { 
                        contratoId: contratoId, versao: versao, justificativa: justif 
                    }).done(function(res) {
                        if (res.sucesso) Swal.fire('Sucesso', res.mensagem, 'success').then(() => location.reload());
                        else Swal.fire('Erro', res.mensagem, 'error');
                    });
                }
            });

            const pageFlags = document.getElementById('pageFlags');
            if (pageFlags) {
                const successMsg = pageFlags.getAttribute('data-success');
                const errorMsg   = pageFlags.getAttribute('data-error');
                if (successMsg) Swal.fire({ icon: 'success', title: 'Sucesso!', text: successMsg, timer: 3000, showConfirmButton: false });
                if (errorMsg) Swal.fire({ icon: 'error', title: 'Atenção', html: errorMsg });
            }
        });
    </script>
}