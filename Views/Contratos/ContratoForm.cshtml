@model Financeiro.Models.ViewModels.ContratoViewModel
@using Financeiro.Models
@{
    ViewData["Title"] = Model.Id == 0 ? "Novo Contrato" : "Editar Contrato";
    var naturezas = ViewBag.Naturezas as IEnumerable<Natureza> ?? Enumerable.Empty<Natureza>();
    var fornecedorAtual = ViewBag.FornecedorAtual as VwFornecedor;
}

@if (TempData["MensagemSucesso"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["MensagemSucesso"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<h3 class="fw-bold mb-4">
    <i class="bi bi-file-earmark-text-fill me-2"></i>@ViewData["Title"]
</h3>
<hr />

<form asp-action="@(Model.Id == 0 ? "Salvar" : "Atualizar")" method="post" class="container px-3">
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
    <input type="hidden" asp-for="Id" />

    <div class="mb-3">
        <label asp-for="FornecedorIdCompleto" class="form-label fw-semibold"></label>
        <select asp-for="FornecedorIdCompleto" id="fornecedor-select" class="form-select">
            @if (fornecedorAtual != null)
            {
                <option value="@Model.FornecedorIdCompleto" selected>
                    @fornecedorAtual.Nome (@fornecedorAtual.Documento)
                </option>
            }
        </select>
        <span asp-validation-for="FornecedorIdCompleto" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="AnoContrato" class="form-label fw-semibold"></label>
        <input asp-for="AnoContrato" class="form-control" type="number" />
        <span asp-validation-for="AnoContrato" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="NumeroContrato" class="form-label fw-semibold"></label>
        <input asp-for="NumeroContrato" class="form-control" type="number" />
        <span asp-validation-for="NumeroContrato" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="ObjetoContrato" class="form-label fw-semibold"></label>
        <textarea asp-for="ObjetoContrato" class="form-control" rows="3"></textarea>
        <span asp-validation-for="ObjetoContrato" class="text-danger"></span>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <label asp-for="DataInicio" class="form-label fw-semibold"></label>
            <input asp-for="DataInicio" class="form-control" type="date" />
            <span asp-validation-for="DataInicio" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="DataFim" class="form-label fw-semibold"></label>
            <input asp-for="DataFim" class="form-control" type="date" />
            <span asp-validation-for="DataFim" class="text-danger"></span>
        </div>
        <div class="col-md-4">
            <label asp-for="DataAssinatura" class="form-label fw-semibold"></label>
            <input asp-for="DataAssinatura" class="form-control" type="date" />
            <span asp-validation-for="DataAssinatura" class="text-danger"></span>
        </div>
    </div>

    <div class="mb-3">
        <label asp-for="ValorContrato" class="form-label fw-semibold"></label>
        <input asp-for="ValorContrato" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="ValorContrato" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="NaturezasIds" class="form-label fw-semibold"></label>
        <select asp-for="NaturezasIds" class="form-select" id="naturezas-select" multiple>
            @foreach(var natureza in naturezas)
            {
                <option value="@natureza.Id">@natureza.Nome</option>
            }
        </select>
        <span asp-validation-for="NaturezasIds" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="Observacao" class="form-label fw-semibold"></label>
        <textarea asp-for="Observacao" class="form-control" rows="3"></textarea>
    </div>

    <div class="form-check mb-4">
        <input class="form-check-input" type="checkbox" asp-for="Ativo">
        <label class="form-check-label fw-semibold" asp-for="Ativo"></label>
    </div>

    <div>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-circle me-1"></i> Salvar Alterações
        </button>
        <a asp-action="Index" class="btn btn-secondary ms-2">
            <i class="bi bi-x-circle me-1"></i> Cancelar
        </a>

        @if (Model.Id > 0)
        {
            <a asp-controller="AditivosContrato" asp-action="Novo" asp-route-contratoId="@Model.Id" class="btn btn-info float-end">
                <i class="bi bi-plus-circle me-1"></i> Aditivar Contrato
            </a>
        }
    </div>
</form>

@if (Model.Id > 0)
{
    <hr class="my-4" />
    <h4 class="fw-bold">Histórico de Aditivos</h4>
    <div id="historico-container">
        <p>Carregando histórico...</p>
    </div>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            $('#fornecedor-select').select2({
                theme: 'bootstrap-5',
                placeholder: 'Digite para buscar um fornecedor',
                minimumInputLength: 1,
                ajax: {
                    url: '@Url.Action("BuscarFornecedores", "Contratos")',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            term: params.term,
                            page: params.page || 1
                        };
                    },
                    processResults: function (data, params) {
                        params.page = params.page || 1;
                        return {
                            results: data.results,
                            pagination: {
                                more: data.pagination.more
                            }
                        };
                    },
                    cache: true
                }
            });

            $('#naturezas-select').select2({
                theme: 'bootstrap-5',
                placeholder: 'Selecione uma ou mais naturezas'
            });

            $('#AnoContrato').on('change', function () {
                var ano = $(this).val();
                if (ano && @Model.Id == 0) {
                    $.get('@Url.Action("SugerirNumero", "Contratos")', { ano: ano }, function (data) {
                        $('#NumeroContrato').val(data.proximoNumero);
                    });
                }
            }).trigger('change');

            if (@Model.Id > 0) {
                $('#historico-container').load('@Url.Action("Historico", "Contratos", new { id = Model.Id })');
            }
        });
    </script>
}