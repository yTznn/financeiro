@model IEnumerable<Financeiro.Models.ContratoVersao>
@using System.Globalization
@using Financeiro.Models

@{
    var br = new CultureInfo("pt-BR");
    // Recebe paginação do Controller (ViewBag)
    int totalPaginas = ViewBag.TotalPaginas ?? 0;
    int paginaAtual  = ViewBag.PaginaAtual ?? 1;
    int contratoId   = ViewBag.ContratoId ?? 0;

    // Helper local para Badges
    string BadgeTipo(ContratoVersao v)
    {
        if (v.TipoAditivo == null) return "<span class='badge bg-secondary'>Original</span>";
        
        // Conversão segura caso o Enum seja Nullable ou Int
        var tipo = v.TipoAditivo.ToString(); 

        return tipo switch
        {
            "Prazo"          => "<span class='badge bg-info text-dark'>Prazo</span>",
            "Acrescimo"      => "<span class='badge bg-success'>Acréscimo</span>",
            "Supressao"      => "<span class='badge bg-danger'>Supressão</span>",
            "PrazoAcrescimo" => "<span class='badge bg-success'>Prazo + Valor</span>",
            "PrazoSupressao" => "<span class='badge bg-warning text-dark'>Prazo + Supressão</span>",
            _                => $"<span class='badge bg-light text-dark border'>{tipo}</span>"
        };
    }
}

<style>
  .hist-table th { font-size: 0.85rem; text-transform: uppercase; background-color: #f8f9fa; }
  .hist-table td { vertical-align: middle; font-size: 0.9rem; }
  .hist-money { font-family: monospace; font-weight: 600; }
</style>

<div class="table-responsive">
  <table class="table table-hover hist-table mb-0">
    <thead>
      <tr>
        <th class="text-center">Versão</th>
        <th>Tipo</th>
        <th class="text-center">Data Registro</th>
        <th class="text-center">Vigência</th>
        <th class="text-end">Valor Global</th>
        <th>Observação</th>
      </tr>
    </thead>
    <tbody>
    @if(Model != null && Model.Any())
    {
        foreach (var v in Model)
        {
            <tr>
              <td class="text-center fw-bold text-primary">v.@v.Versao</td>
              <td>@Html.Raw(BadgeTipo(v))</td>
              <td class="text-center">@v.DataRegistro.ToString("dd/MM/yy HH:mm")</td>
              <td class="text-center small">
                  @v.DataInicio.ToString("dd/MM/yy") <br> 
                  <span class="text-muted">até</span> @v.DataFim.ToString("dd/MM/yy")
              </td>
              <td class="text-end hist-money">
                  @v.ValorContrato.ToString("C", br)
              </td>
              <td class="small text-muted text-truncate" style="max-width: 150px;" title="@v.Observacao">
                  @v.Observacao
              </td>
            </tr>
        }
    }
    else 
    {
        <tr>
            <td colspan="6" class="text-center py-4 text-muted">
                <i class="bi bi-info-circle me-2"></i> Nenhum histórico encontrado.
            </td>
        </tr>
    }
    </tbody>
  </table>
</div>

@* Paginação do Modal *@
@if (totalPaginas > 1)
{
    <nav class="mt-3 d-flex justify-content-center">
        <ul class="pagination pagination-sm mb-0">
            @for (var i = 1; i <= totalPaginas; i++)
            {
                <li class="page-item @(i == paginaAtual ? "active" : "")">
                    <a class="page-link historico-page-link" href="#" data-page="@i" data-contrato-id="@contratoId">@i</a>
                </li>
            }
        </ul>
    </nav>
    
    <script>
        // Script específico para paginar dentro do SweetAlert/Modal sem recarregar a página toda
        // Nota: O evento 'click' é delegado no body ou container pai para funcionar em elementos dinâmicos
        $('.historico-page-link').on('click', function (e) {
            e.preventDefault();
            const page = $(this).data('page');
            const cId = $(this).data('contrato-id');
            const url = '@Url.Action("Historico", "Contratos")' + '?id=' + cId + '&pag=' + page;
            
            // Recarrega o conteúdo dentro do container do SweetAlert
            // (Assumindo que o container tem a classe swal-aditivos que definimos no Index)
            $('.swal-aditivos').load(url);
        });
    </script>
}