@model IEnumerable<Financeiro.Models.ContratoVersao>
@using System.Globalization
@using Financeiro.Models

@{
    var br = new CultureInfo("pt-BR");
    // Recebe paginação do Controller
    int totalPaginas = ViewBag.TotalPaginas ?? 0;
    int paginaAtual  = ViewBag.PaginaAtual ?? 1;
    int contratoId   = ViewBag.ContratoId ?? 0;

    string BadgeTipo(ContratoVersao v)
    {
        if (v?.TipoAditivo == null) return "<span class=\"badge bg-secondary-subtle text-secondary\">Original</span>";
        return v.TipoAditivo switch
        {
            TipoAditivo.Prazo            => "<span class=\"badge bg-info-subtle text-info\">Prazo</span>",
            TipoAditivo.Acrescimo        => "<span class=\"badge bg-success-subtle text-success\">Acréscimo</span>",
            TipoAditivo.Supressao        => "<span class=\"badge bg-danger-subtle text-danger\">Supressão</span>",
            TipoAditivo.PrazoAcrescimo   => "<span class=\"badge bg-success-subtle text-success\">Prazo + Acréscimo</span>",
            TipoAditivo.PrazoSupressao   => "<span class=\"badge bg-danger-subtle text-danger\">Prazo + Supressão</span>",
            _                            => $"<span class=\"badge bg-secondary-subtle text-secondary\">{v.TipoAditivo}</span>"
        };
    }
}

<style>
  #hist-contrato .table { font-size: .92rem; }
  #hist-contrato th, #hist-contrato td { vertical-align: middle; white-space: normal; }
  #hist-contrato .nowrap { white-space: nowrap; }
  #hist-contrato .money { font-variant-numeric: tabular-nums; }
  #hist-contrato thead th { background-color:#0d6efd14; }
</style>

<div id="hist-contrato">
  <table class="table table-sm table-hover table-bordered align-middle d-none d-md-table mb-2">
    <thead class="table-light text-center">
      <tr>
        <th class="nowrap">Versão</th>
        <th>Tipo de Aditivo</th>
        <th>Início do Aditivo</th>
        <th class="nowrap">Valor Global</th>
        <th>Vigência</th>
        <th>Data Registro</th>
      </tr>
    </thead>
    <tbody>
    @if(Model != null)
    {
        foreach (var v in Model)
        {
            <tr>
              <td class="text-center fw-semibold nowrap">@v.Versao</td>
              <td>@Html.Raw(BadgeTipo(v))</td>
              <td class="text-center">@((v.DataInicioAditivo?.ToString("dd/MM/yyyy")) ?? "-")</td>
              <td class="text-end nowrap money">@v.ValorContrato.ToString("C", br)</td>
              <td class="text-center">@v.DataInicio.ToString("dd/MM/yyyy") a @v.DataFim.ToString("dd/MM/yyyy")</td>
              <td class="text-center">@v.DataRegistro.ToString("dd/MM/yyyy HH:mm")</td>
            </tr>
        }
    }
    else 
    {
        <tr><td colspan="6" class="text-center text-muted">Nenhum histórico encontrado.</td></tr>
    }
    </tbody>
  </table>

  <div class="accordion d-md-none" id="historicoAccordion">
    @if(Model != null)
    {
        foreach (var v in Model)
        {
            var collapseId = $"collapse-{v.Versao}";
            <div class="accordion-item mb-2">
              <h2 class="accordion-header" id="h@collapseId">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId">
                  Versão @v.Versao
                </button>
              </h2>
              <div id="@collapseId" class="accordion-collapse collapse" data-bs-parent="#historicoAccordion">
                <div class="accordion-body small">
                  <p class="mb-1"><strong>Tipo:</strong> @Html.Raw(BadgeTipo(v))</p>
                  <p class="mb-1"><strong>Valor:</strong> @v.ValorContrato.ToString("C", br)</p>
                  <p class="mb-1"><strong>Vigência:</strong> @v.DataInicio.ToString("dd/MM/yyyy") a @v.DataFim.ToString("dd/MM/yyyy")</p>
                </div>
              </div>
            </div>
        }
    }
  </div>

  @if (totalPaginas > 1)
  {
    <nav class="mt-2">
      <ul class="pagination pagination-sm justify-content-center">
        @for (var i = 1; i <= totalPaginas; i++)
        {
          <li class="page-item @(i == paginaAtual ? "active" : "")">
            <a class="page-link historico-page-link" href="#" data-page="@i" data-contrato-id="@contratoId">@i</a>
          </li>
        }
      </ul>
    </nav>
  }
</div>

<script>
    // Apenas lógica de paginação, sem cancelamento aqui dentro
    $(document).off('click', '.historico-page-link').on('click', '.historico-page-link', function (e) {
        e.preventDefault();
        const page = $(this).data('page');
        const cId = $(this).data('contrato-id');
        const container = $('#historico-container'); // Certifique-se que o ID na View principal é este
        if(container.length) {
            container.load('@Url.Action("Historico","Contratos")' + '?id=' + cId + '&pag=' + page);
        }
    });
</script>