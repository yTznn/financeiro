@model Financeiro.Models.ViewModels.InstrumentoViewModel
@using System.Globalization

@{
    ViewBag.Title = Model.Id == 0 ? "Novo Instrumento" : "Editar Instrumento";
    Layout        = "_Layout";
    var action    = (string?)ViewBag.FormAction ?? (Model.Id == 0 ? "Salvar" : "Atualizar");

    // Tipagem forte para evitar erros
    var versaoAtual = ViewBag.VersaoAtual as Financeiro.Models.InstrumentoVersao;

    // Resumo atual consolidado
    var resumo = ViewBag.ResumoAtual as Financeiro.Models.ViewModels.InstrumentoResumoViewModel;

    // Cálculo do "vigente" com fallback
    decimal   valorVig = versaoAtual?.Valor ?? Model.Valor;
    DateTime  iniVig   = versaoAtual?.VigenciaInicio ?? Model.DataInicio;
    DateTime? fimVig   = versaoAtual?.VigenciaFim ?? Model.DataFim;
    string    fimVigTxt= fimVig.HasValue ? fimVig.Value.ToString("dd/MM/yyyy") : "atual";

    var br = new CultureInfo("pt-BR");
}

<h2 class="mb-4">@ViewBag.Title</h2>

@* --- CARD DE RESUMO FINANCEIRO (SÓ APARECE NA EDIÇÃO) --- *@
@if (resumo != null)
{
  <div class="card shadow-sm border-0 mb-2">
    <div class="card-header bg-light d-flex align-items-center justify-content-between">
      <strong>Resumo Atual do Instrumento</strong>
      @if (Model.Id != 0 && ViewBag.ResumoAtual != null) {
        var r = (Financeiro.Models.ViewModels.InstrumentoResumoViewModel)ViewBag.ResumoAtual;
        <a class="btn btn-outline-secondary btn-sm"
           asp-controller="RecebimentosInstrumento" 
           asp-action="Index"
           asp-route-instrumentoId="@resumo.InstrumentoId"> 
           Ver Recebimentos
        </a>
      }
    </div>
    <div class="card-body p-3 p-md-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label text-muted small text-uppercase">Valor Total</label>
          <input class="form-control fw-bold" value="@resumo.ValorTotalAtual.ToString("C", br)" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small text-uppercase">Valor Mensal</label>
          <input class="form-control" value="@resumo.ValorMensalAtual.ToString("C", br)" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small text-uppercase">Início Vigência</label>
          <input class="form-control" value="@resumo.VigenciaInicio.ToString("dd/MM/yyyy")" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small text-uppercase">Fim Vigência</label>
          <input class="form-control" value="@resumo.VigenciaFimAtual.ToString("dd/MM/yyyy")" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small text-uppercase">Duração (Meses)</label>
          <input class="form-control" value="@resumo.MesesVigentesAtuais" readonly />
        </div>
        <div class="col-md-3">
          <label class="form-label text-muted small text-uppercase">Saldo Disponível</label>
          <input class="form-control text-primary fw-bold" value="@resumo.SaldoAtual.ToString("C", br)" readonly />
        </div>
      </div>
    </div>
  </div>
}

@* --- CARD DE STATUS DO REGISTRO --- *@
<div class="card shadow-sm border-0 mb-4">
  <div class="card-body p-3 p-md-4">
    <div class="d-flex flex-wrap align-items-center gap-3">
      <div class="flex-grow-1">
        <div class="d-flex align-items-center gap-2 mb-1">
          <span class="badge bg-info-subtle text-info fw-semibold">Instrumento</span>
          @if (Model.Id != 0)
          {
            <span class="badge @(Model.Ativo ? "bg-success" : "bg-secondary")">
              @(Model.Ativo ? "Ativo" : "Inativo")
            </span>
             @if (Model.Vigente)
             {
                 <span class="badge bg-primary">Vigente (Padrão)</span>
             }
          }
        </div>

        <div class="fs-5 fw-semibold mb-1">
          <span id="resumoEntidade">Entidade: (carregando...)</span>
        </div>

        <div class="text-muted">
          Período (base): <span id="resumoPeriodo">
            @(Model.DataInicio != default && Model.DataFim != default
              ? $"{Model.DataInicio:dd/MM/yyyy} → {Model.DataFim:dd/MM/yyyy}"
              : "definir datas")
          </span>
        </div>

        <div class="text-muted mt-1">
          Vigência vigente:
          <span class="badge rounded-pill bg-secondary-subtle text-secondary">
            @iniVig.ToString("dd/MM/yyyy") → @fimVigTxt
          </span>
        </div>
      </div>

      <div class="text-end ms-auto">
        <div class="text-muted small">Valor vigente</div>
        <div class="display-6 fw-bold" id="resumoValorVigente">
          @valorVig.ToString("C", br)
        </div>
      </div>
    </div>
  </div>
</div>

@* --- BOTÕES DE AÇÃO (ADITIVOS) --- *@
@if (Model.Id != 0)
{
  <div class="mb-3 d-flex flex-wrap gap-2">
    <a asp-controller="AditivosInstrumento" asp-action="Novo" asp-route-instrumentoId="@Model.Id" class="btn btn-outline-primary">
      <i class="bi bi-file-earmark-plus"></i> Registrar Aditivo
    </a>
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalHistorico">
      <i class="bi bi-clock-history"></i> Histórico de Aditivos
    </button>
    @if (versaoAtual != null)
    {
      <a class="btn btn-outline-danger" id="btnCancelarAditivo"
         data-instrumento="@Model.Id" data-versao="@versaoAtual.Versao">
        <i class="bi bi-x-circle"></i> Cancelar último aditivo
      </a>
    }
  </div>
}

<div asp-validation-summary="All" class="text-danger mb-2"></div>

@* --- FORMULÁRIO PRINCIPAL --- *@
<form id="formInstrumento" asp-controller="Instrumentos" asp-action="@action" method="post" class="row g-3" novalidate>
  @Html.AntiForgeryToken()
  <input type="hidden" asp-for="Id" />
  @if (Model.Id != 0) { <input type="hidden" name="id" value="@Model.Id" /> }

  <div class="col-md-6">
    <label asp-for="EntidadeId" class="form-label">Entidade</label>
    <select asp-for="EntidadeId" 
            class="form-select bg-light text-primary fw-bold" 
            asp-items="ViewBag.Entidades" 
            id="EntidadeId" 
            style="pointer-events: none;" 
            tabindex="-1">
    </select>
    <span asp-validation-for="EntidadeId" class="text-danger"></span>
  </div>

  <div class="col-md-3">
    <label asp-for="Numero" class="form-label">Número</label>
    <input asp-for="Numero" class="form-control" id="Numero" placeholder="Ex: 01/2025" />
    <span asp-validation-for="Numero" class="text-danger"></span>
  </div>

  <div class="col-md-12">
    <div class="card mb-3">
      <div class="card-header">
        <strong>Valor do Instrumento</strong>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-center">
          <div class="col-md-4">
            <div class="form-check mt-2">
              <input class="form-check-input" asp-for="UsarValorMensal" id="usarMensal" />
              <label class="form-check-label" for="usarMensal">
                @Html.DisplayNameFor(m => m.UsarValorMensal)
              </label>
            </div>
            <small class="text-muted d-block">
              Se marcado, você informa o <strong>Valor Mensal</strong> e o sistema calcula o <strong>Total</strong>.
            </small>
          </div>

          <div class="col-md-4" id="grupoValorTotal">
            <label asp-for="Valor" class="form-label">Valor Total</label>
            <input asp-for="Valor" class="form-control" id="Valor" />
            <span asp-validation-for="Valor" class="text-danger"></span>
            <small class="text-muted" id="hintTotal"></small>
          </div>

          <div class="col-md-4" id="grupoValorMensal">
            <label asp-for="ValorMensal" class="form-label">Valor Mensal</label>
            <input asp-for="ValorMensal" class="form-control" id="ValorMensal" />
            <span asp-validation-for="ValorMensal" class="text-danger"></span>
            <small class="text-muted" id="hintMensal"></small>
          </div>
        </div>

        <hr class="my-3" />

        <div class="row g-3">
          <div class="col-md-3">
            <label asp-for="DataInicio" class="form-label">Data de Início (base)</label>
            <input asp-for="DataInicio" type="date" class="form-control" id="DataInicio"/>
            <span asp-validation-for="DataInicio" class="text-danger"></span>
          </div>

          <div class="col-md-3">
            <label asp-for="DataFim" class="form-label">Data de Fim (base)</label>
            <input asp-for="DataFim" type="date" class="form-control" id="DataFim"/>
            <span asp-validation-for="DataFim" class="text-danger"></span>
          </div>

          <div class="col-md-3">
            <div class="form-text mt-4">
              A vigência influencia o cálculo entre <em>Total</em> e <em>Mensal</em>.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-12">
    <label asp-for="Objeto" class="form-label">Objeto</label>
    <textarea asp-for="Objeto" class="form-control" rows="3" maxlength="4000" id="Objeto" placeholder="Descrição do objeto do contrato..."></textarea>
    <span asp-validation-for="Objeto" class="text-danger"></span>
  </div>

  <div class="col-md-3">
    <label asp-for="DataAssinatura" class="form-label">Data de Assinatura</label>
    <input asp-for="DataAssinatura" type="date" class="form-control" id="DataAssinatura"/>
    <span asp-validation-for="DataAssinatura" class="text-danger"></span>
  </div>

  <div class="col-md-5 d-flex flex-column gap-2 mt-4">
      <div class="form-check">
          <input asp-for="Ativo" class="form-check-input" id="Ativo" />
          <label asp-for="Ativo" class="form-check-label"><strong>Ativo</strong> (Registro válido no sistema)</label>
      </div>

      <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" asp-for="Vigente" id="checkVigente">
          <label class="form-check-label" for="checkVigente">
              <strong>Definir como Vigente (Padrão)</strong>
              <br />
              <small class="text-muted" style="font-size: 0.85em;">Ao marcar, este será o instrumento principal desta entidade.</small>
          </label>
      </div>
  </div>

  <div class="col-md-12">
    <label asp-for="Observacao" class="form-label">Observações</label>
    <textarea asp-for="Observacao" class="form-control" rows="2" id="Observacao"></textarea>
    <span asp-validation-for="Observacao" class="text-danger"></span>
  </div>

  <div class="col-12 d-flex gap-2 mt-3 border-top pt-3">
    <button type="submit" class="btn btn-success px-4" id="btnSubmit">
      <i class="bi bi-check-lg"></i> @(Model.Id == 0 ? "Salvar" : "Atualizar")
    </button>
    <a asp-controller="Instrumentos" asp-action="Index" class="btn btn-light border px-4">Cancelar</a>
  </div>
</form>

@* --- MODAL DE HISTÓRICO --- *@
@if (Model.Id != 0)
{
  <div class="modal fade" id="modalHistorico" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Histórico de Aditivos</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="histBody">
          <div class="text-center my-3"><div class="spinner-border"></div></div>
        </div>
      </div>
    </div>
  </div>
}

@section Scripts {
  <partial name="_ValidationScriptsPartial" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ====== VALIDADOR DE NÚMERO (pt-BR aceito) ======
    if (window.jQuery && $.validator) {
        $.validator.methods.number = function (value, element) {
            if (this.optional(element)) return true;
            if (/^[-]?(\d+|\d{1,3}(,\d{3})*)(\.\d+)?$/.test(value)) return true;
            const br = value.replace(/\./g, "").replace(",", ".");
            return /^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(br);
        };
    }

    // ====== ELEMENTOS DOM ======
    const selEntidade   = document.getElementById('EntidadeId');
    const resumoEntidade= document.getElementById('resumoEntidade');
    const resumoValor   = document.getElementById('resumoValor');
    const resumoPeriodo = document.getElementById('resumoPeriodo');

    const inValor       = document.getElementById('Valor');
    const inValorMensal = document.getElementById('ValorMensal');
    const usarMensal    = document.getElementById('usarMensal');

    const di            = document.getElementById('DataInicio');
    const df            = document.getElementById('DataFim');
    const inNumero      = document.getElementById('Numero');
    const obs           = document.getElementById('Observacao');
    const objeto        = document.getElementById('Objeto');

    const hintTotal     = document.getElementById('hintTotal');
    const hintMensal    = document.getElementById('hintMensal');

    const grpTotal      = document.getElementById('grupoValorTotal');
    const grpMensal     = document.getElementById('grupoValorMensal');

    // Funções Auxiliares
    function toNumberBR(raw) {
      if (!raw) return 0;
      const s = raw.replace(/\./g, '').replace(',', '.');
      const n = Number(s);
      return isFinite(n) ? n : 0;
    }

    function getValorTotal(){ return toNumberBR(inValor?.value ?? ''); }
    function getValorMensal(){ return toNumberBR(inValorMensal?.value ?? ''); }

    function mesesEntre(inicio, fim) {
        if (!inicio || !fim) return null;
        const [anoI, mesI, diaI] = inicio.split('-').map(Number);
        const [anoF, mesF, diaF] = fim.split('-').map(Number);
        if (!anoI || !anoF) return null;
        let meses = (anoF - anoI) * 12 + (mesF - mesI);
        return meses + 1; // inclusivo
    }
    
    function formatCurrency(n) {
        if (isNaN(n)) return '';
        try { return n.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        catch { return n.toFixed(2); }
    }

    // Atualiza o painel superior de resumo
    function atualizarResumo(){
      // Pega o texto da entidade selecionada (ou travada)
      const optText = selEntidade?.selectedOptions?.length ? selEntidade.selectedOptions[0].text : '';
      resumoEntidade.textContent = 'Entidade: ' + (optText || '(carregando...)');

      const v = getValorTotal();
      if(resumoValor) resumoValor.textContent = v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

      const d1 = di?.value, d2 = df?.value;
      if(resumoPeriodo) {
          resumoPeriodo.textContent = (d1 && d2)
            ? new Date(d1).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) + ' → ' + new Date(d2).toLocaleDateString('pt-BR', { timeZone: 'UTC' })
            : 'definir datas';
      }

      updateHints();
    }

    // Atualiza as dicas abaixo dos campos de valor
    function updateHints() {
        const m = mesesEntre(di?.value, df?.value);

        if (usarMensal?.checked) {
            const vm = getValorMensal();
            if (m && vm) {
                const total = vm * m;
                hintMensal.textContent = `Vigência: ${m} meses. Total estimado = ${formatCurrency(total)}.`;
                hintTotal.textContent = '';
            } else {
                hintMensal.textContent = m ? `Vigência: ${m} meses.` : '';
                hintTotal.textContent = '';
            }
        } else {
            const vt = getValorTotal();
            if (m && vt) {
                const mensal = vt / m;
                hintTotal.textContent = `Vigência: ${m} meses. Mensal estimado = ${formatCurrency(mensal)}.`;
                hintMensal.textContent = '';
            } else {
                hintTotal.textContent = m ? `Vigência: ${m} meses.` : '';
                hintMensal.textContent = '';
            }
        }
    }

    // Alterna entre digitar Total ou Mensal
    function toggleModo() {
        const usandoMensal = !!usarMensal?.checked;

        grpMensal.style.display = usandoMensal ? '' : 'none';
        grpTotal.style.display  = usandoMensal ? 'none' : '';

        if (inValorMensal) inValorMensal.required = usandoMensal;
        if (inValor)       inValor.required       = !usandoMensal;

        updateHints();
    }

    // Sanitização de inputs
    const badCharsRegex = /[\u{1F300}-\u{1FAFF}\u{1F600}-\u{1F64F}*!@@#']/gu;
    function sanitizeInput(el){ if(!el) return; const c=(el.value||'').replace(badCharsRegex,''); if(c!==el.value) el.value=c; }
    [inNumero, obs, objeto].forEach(el=>{
      el?.addEventListener('input', ()=>sanitizeInput(el));
    });

    // Listeners
    selEntidade?.addEventListener('change', atualizarResumo);
    
    inValor?.addEventListener('input', atualizarResumo);
    inValor?.addEventListener('keyup', atualizarResumo);
    inValorMensal?.addEventListener('input', updateHints);
    inValorMensal?.addEventListener('keyup', updateHints);

    di?.addEventListener('change', atualizarResumo);
    df?.addEventListener('change', atualizarResumo);

    usarMensal?.addEventListener('change', toggleModo);

    // Inicialização
    toggleModo();
    setTimeout(atualizarResumo, 100);

    // Submit do Formulário
    const form = document.getElementById('formInstrumento');
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      if (!selEntidade.value){
        return Swal.fire({ icon:'warning', title:'Atenção', text:'Erro ao identificar a entidade logada.' });
      }

      const confirm = await Swal.fire({
        icon:'question',
        title:'Confirmar gravação?',
        showCancelButton:true,
        confirmButtonText:'Sim, Salvar',
        cancelButtonText:'Cancelar'
      });
      if (!confirm.isConfirmed) return;

      // Se estiver usando valor mensal, precisamos garantir que o campo Valor Total não vá vazio (ou zero) se possível
      // Mas o backend recalcula tudo. O importante é submeter.
      form.submit();
    });

    // Scripts do Histórico / Cancelamento (mantidos)
    const btnCancelarAditivo = document.getElementById('btnCancelarAditivo');
    if(btnCancelarAditivo) {
        btnCancelarAditivo.addEventListener('click', async () => {
             const instrumentoId=parseInt(btnCancelarAditivo.getAttribute('data-instrumento'),10);
             let versao=parseInt(btnCancelarAditivo.getAttribute('data-versao'),10) || 0;
             if(!instrumentoId || !versao){ return; }
             
             const { value: justificativa } = await Swal.fire({
                title:'Cancelar aditivo', input:'textarea', inputLabel:'Justificativa',
                inputValidator:v=>!v?.trim()?'Obrigatório.':undefined,
                showCancelButton:true, confirmButtonText:'Confirmar', confirmButtonColor:'#dc3545'
             });
             if(!justificativa) return;

             try{
                const res=await fetch('/AditivosInstrumento/Cancelar',{ method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({ instrumentoId, versao, justificativa }) });
                if(!res.ok){ const msg=await res.text(); return Swal.fire('Erro', msg, 'error'); }
                location.reload();
             }catch{ Swal.fire('Erro','Falha na comunicação','error'); }
        });
    }

    // Modal Histórico
    const modal = document.getElementById('modalHistorico');
    const bodyDiv = $('#histBody');
    if (modal && bodyDiv.length) {
      modal.addEventListener('shown.bs.modal', () => {
        const url = '@Url.Action("Historico","Instrumentos")' + '?id=@Model.Id&pag=1';
        bodyDiv.html('<div class="text-center my-3"><div class="spinner-border"></div></div>');
        bodyDiv.load(url);
      });
    }
    $(document).on('click', '.hist-page-link', function (e) {
        e.preventDefault();
        const p  = $(this).data('pagina');
        const id = $(this).data('instrumento-id') || @Model.Id;
        const url = '@Url.Action("Historico","Instrumentos")' + '?id=' + id + '&pag=' + p;
        $('#histBody').load(url);
    });

    // Feedback TempData
    const ok  = @Html.Raw(Json.Serialize(TempData["Sucesso"]?.ToString() ?? "")); 
    const err = @Html.Raw(Json.Serialize(TempData["Erro"]?.ToString() ?? ""));    
    if (ok)  Swal.fire({ icon:'success', title:'Sucesso', text: ok, timer: 3000, showConfirmButton:false });
    if (err) Swal.fire({ icon:'error',   title:'Erro',    text: err });
  });
  </script>

  <style>
    .card .badge.bg-info-subtle { background:#e6f4ff !important; color:#0b6bcb !important; }
    /* Ajuste para o campo de entidade parecer readonly mas bonito */
    #EntidadeId { 
        cursor: not-allowed; 
        opacity: 0.8;
        border-color: #dee2e6;
    }
  </style>
}