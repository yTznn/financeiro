@model int
@{
    ViewBag.Title = "Endereços da Pessoa Física";
    Layout = "_Layout";
    var pessoaFisicaId = Model;
}

<div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="fw-bold text-primary">@ViewBag.Title</h2>
            <p class="text-muted mb-0">Gerencie os endereços vinculados. Apenas um pode ser o principal.</p>
        </div>

        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary"
               asp-controller="PessoasFisicas"
               asp-action="Index">
                <i class="bx bx-arrow-back me-1"></i> Voltar
            </a>

            <a class="btn btn-primary"
               asp-controller="Enderecos"
               asp-action="NovoPF"
               asp-route-pessoaId="@pessoaFisicaId">
                <i class="bx bx-plus-circle me-1"></i> Novo Endereço
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table align-middle" id="tbl-enderecos">
                    <thead class="table-light">
                        <tr>
                            <th style="width:60px;">Principal</th>
                            <th>Logradouro</th>
                            <th style="width:120px;">Número</th>
                            <th>Complemento</th>
                            <th style="width:120px;">CEP</th>
                            <th>Bairro</th>
                            <th>Município</th>
                            <th style="width:80px;">UF</th>
                            <th style="width:180px;" class="text-center">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-enderecos">
                        <tr><td colspan="9" class="text-muted">Carregando...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- flags p/ toasts vindos de TempData (sucesso/infos após Salvar/Atualizar) -->
<div id="pageFlags"
     data-success="@TempData["toast:success"]"
     data-info="@TempData["toast:info"]"></div>

<!-- Antiforgery para os POSTs AJAX -->
<form id="antiForgeryForm">@Html.AntiForgeryToken()</form>

@section Scripts {
<script>
(function () {
    const pessoaId = @pessoaFisicaId;

    // Rotas de atributo (iguais às do controller PF):
    const urlListar              = `/Enderecos/PessoaFisica/${pessoaId}/Listar`;
    const urlPrincipal           = `/Enderecos/PessoaFisica/${pessoaId}/Principal`;
    const urlDefinirPrincipalTpl = `/Enderecos/PessoaFisica/${pessoaId}/DefinirPrincipal/__ID__`;
    const urlEditarTpl           = `/Enderecos/PessoaFisica/${pessoaId}/Editar/__ID__`;
    const urlExcluirTpl          = `/Enderecos/PessoaFisica/${pessoaId}/Excluir/__ID__`;

    const $tbody = $("#tbody-enderecos");

    // ===== SweetAlert helpers (mesmo padrão da tela de PJ)
    function swalMsg(message, type){
        if (window.SwalDefault?.fire) {
            SwalDefault.fire(message || "", "", type || "info");
        } else if (window.Swal?.fire) {
            Swal.fire({ text: message || "", icon: type || "info" });
        } else { alert(message || ""); }
    }
    function swalConfirm(opts){
        if (window.SwalDelete?.fire) {
            return window.SwalDelete.fire({
                title: opts.title || "Confirmar?",
                text:  opts.text  || "",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: opts.confirmText || "Sim",
                cancelButtonText:  opts.cancelText  || "Cancelar"
            });
        } else if (window.Swal?.fire) {
            return window.Swal.fire({
                title: opts.title || "Confirmar?",
                text:  opts.text  || "",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: opts.confirmText || "Sim",
                cancelButtonText:  opts.cancelText  || "Cancelar"
            });
        } else {
            return Promise.resolve({ isConfirmed: confirm(opts.text || "Confirmar?") });
        }
    }
    function token() {
        return $("#antiForgeryForm input[name='__RequestVerificationToken']").val();
    }

    // ===== UI row (estrela igual ao PJ)
    function linhaEndereco(e) {
        const estrela = e.principal
            ? `<button type="button" class="btn btn-link p-0" title="Endereço principal" disabled>
                   <i class="bx bxs-star" style="font-size:1.25rem; color:#f5c518;"></i>
               </button>`
            : `<button type="button" class="btn btn-link p-0 btn-definir-principal"
                       data-id="${e.id}" title="Definir como principal">
                   <i class="bx bx-star" style="font-size:1.25rem;"></i>
               </button>`;

        // Padrão de botões idêntico ao da Entidade/PJ
        const acoes = `
            <div class="btn-group" role="group">
                <a href="${urlEditarTpl.replace("__ID__", e.id)}"
                   class="btn btn-primary btn-sm" title="Editar">
                    <i class="bx bx-edit-alt me-1"></i>
                    <span>Editar</span>
                </a>
                <button type="button" class="btn btn-outline-danger btn-sm btn-excluir"
                        data-id="${e.id}" title="Excluir">
                    <i class="bx bx-trash"></i>
                </button>
            </div>
        `;

        return `
            <tr>
                <td class="text-center">${estrela}</td>
                <td>${e.logradouro ?? ""}</td>
                <td>${e.numero ?? ""}</td>
                <td>${e.complemento ?? ""}</td>
                <td>${e.cep ?? ""}</td>
                <td>${e.bairro ?? ""}</td>
                <td>${e.municipio ?? ""}</td>
                <td>${e.uf ?? ""}</td>
                <td class="text-center">${acoes}</td>
            </tr>
        `;
    }

    // ===== Data loaders
    function carregar() {
        $.get(urlListar)
         .done(function (resp) {
            if (!resp || !resp.sucesso) {
                $tbody.html(`<tr><td colspan="9" class="text-danger">Falha ao carregar endereços.</td></tr>`);
                swalMsg("Falha ao carregar endereços.", "error");
                return;
            }
            const itens = resp.itens || [];
            if (!itens.length) {
                $tbody.html(`<tr><td colspan="9" class="text-muted">Nenhum endereço cadastrado para esta pessoa física.</td></tr>`);
                return;
            }
            let html = "";
            for (const e of itens) html += linhaEndereco(e);
            $tbody.html(html);
         })
         .fail(function (xhr) {
            $tbody.html(`<tr><td colspan="9" class="text-danger">Erro ao consultar o servidor.</td></tr>`);
            swalMsg(\`Erro ao consultar o servidor. (\${xhr.status})\`, "error");
         });
    }

    function atualizarPrincipalEmOutrosContextos() {
        $.get(urlPrincipal)
         .done(function (resp) {
            if (!resp?.sucesso || !resp.possuiPrincipal) return;
            // Mesma convenção da PJ, só mudando o tipo para "PF"
            if (typeof window.atualizarCardEnderecoFornecedor === "function") {
                window.atualizarCardEnderecoFornecedor({
                    tipo: "PF",
                    id: pessoaId,
                    endereco: resp.endereco
                });
            }
         });
    }

    // ===== Actions
    function definirPrincipal(enderecoId) {
        const url = urlDefinirPrincipalTpl.replace("__ID__", enderecoId);
        $.ajax({
            type: "POST",
            url: url,
            headers: { "RequestVerificationToken": token(), "X-Requested-With": "XMLHttpRequest" }
        })
        .done(function (resp) {
            if (resp?.sucesso) {
                swalMsg(resp.mensagem || "Endereço definido como principal!", "success");
                carregar();
                atualizarPrincipalEmOutrosContextos();
            } else {
                swalMsg(resp?.mensagem || "Não foi possível definir o principal.", "error");
            }
        })
        .fail(function (xhr) {
            const msg = xhr.responseJSON?.mensagem || \`Falha ao definir o principal. (\${xhr.status})\`;
            swalMsg(msg, "error");
        });
    }

    function excluir(enderecoId) {
        swalConfirm({
            title: "Excluir endereço?",
            text:  "Esta ação não poderá ser desfeita.",
            confirmText: "Sim, excluir",
            cancelText: "Cancelar"
        }).then(res => {
            if (!res.isConfirmed) return;

            const url = urlExcluirTpl.replace("__ID__", enderecoId);
            $.ajax({
                type: "POST",
                url: url,
                headers: { "RequestVerificationToken": token(), "X-Requested-With": "XMLHttpRequest" }
            })
            .done(function (resp) {
                if (resp?.sucesso) {
                    swalMsg(resp.mensagem || "Endereço excluído.", "success");
                    carregar();
                    atualizarPrincipalEmOutrosContextos();
                } else {
                    swalMsg(resp?.mensagem || "Não foi possível excluir.", "error");
                }
            })
            .fail(function (xhr) {
                const msg = xhr.responseJSON?.mensagem || \`Falha ao excluir. (\${xhr.status})\`;
                swalMsg(msg, "error");
            });
        });
    }

    // ===== Eventos
    $(document).on("click", ".btn-definir-principal", function () {
        definirPrincipal($(this).data("id"));
    });
    $(document).on("click", ".btn-excluir", function () {
        excluir($(this).data("id"));
    });

    // ===== Inicial
    carregar();
    atualizarPrincipalEmOutrosContextos();

    // Toast pós-redirect (Salvar/Atualizar) — mesmo padrão da PJ
    const flags = document.getElementById("pageFlags");
    if (flags) {
        const ok = flags.dataset.success;
        const info = flags.dataset.info;
        if (ok)   swalMsg(ok, "success");
        if (info) swalMsg(info, "info");
    }
})();
</script>
}