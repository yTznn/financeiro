@model Financeiro.Models.ViewModels.RecebimentoViewModel

@{
    ViewData["Title"] = Model.Id == 0 ? "Novo Recebimento" : "Editar Recebimento";
    var action = Model.Id == 0 ? "Salvar" : "Atualizar";
}

<h2>@ViewData["Title"]</h2>
<p class="text-muted">Instrumento NÂº @Model.InstrumentoNumero</p>
<hr />

<form asp-action="@action" method="post" id="form-recebimento">
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="InstrumentoId" />

    <input type="hidden" name="Valor" id="ValorNumerico" value="@Model.Valor.ToString(System.Globalization.CultureInfo.InvariantCulture)" />

    <div class="row">
        <div class="col-md-4 mb-3">
            <label asp-for="Valor" class="form-label"></label>
            <input id="ValorComMascara" type="text" class="form-control" />
            <span asp-validation-for="Valor" class="text-danger"></span>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="DataInicio" class="form-label"></label>
            <input asp-for="DataInicio" class="form-control" type="date" />
            <span asp-validation-for="DataInicio" class="text-danger"></span>
        </div>
        <div class="col-md-4 mb-3">
            <label asp-for="DataFim" class="form-label"></label>
            <input asp-for="DataFim" class="form-control" type="date" />
            <span asp-validation-for="DataFim" class="text-danger"></span>
        </div>
    </div>
    <div class="row">
        <div class="col-12 mb-3">
            <label asp-for="Observacao" class="form-label"></label>
            <textarea asp-for="Observacao" class="form-control" rows="3"></textarea>
            <span asp-validation-for="Observacao" class="text-danger"></span>
        </div>
    </div>

    <div class="mt-3">
        <button type="submit" class="btn btn-primary">Salvar</button>
        <a asp-action="Index" asp-route-instrumentoId="@Model.InstrumentoId" class="btn btn-secondary">Cancelar</a>
    </div>
</form>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    
    <script src="https://unpkg.com/simple-mask-money@1.1.0/dist/simple-mask-money.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const inputComMascara = document.getElementById('ValorComMascara');
            const inputNumerico = document.getElementById('ValorNumerico');
            const form = document.getElementById('form-recebimento');

            const args = {
                allowNegative: false,
                negativeSignAfter: false,
                prefix: 'R$ ',
                fixed: true,
                fractionDigits: 2,
                decimalSeparator: ',',
                thousandsSeparator: '.',
                cursor: 'end'
            };

            SimpleMaskMoney.setMask(inputComMascara, args);

            if (inputNumerico.value && parseFloat(inputNumerico.value) > 0) {
                const valorInicial = parseFloat(inputNumerico.value);
                inputComMascara.value = SimpleMaskMoney.format(valorInicial, args);
            }

            form.addEventListener('submit', function () {
                const valorLimpo = SimpleMaskMoney.formatToNumber(inputComMascara.value);
                inputNumerico.value = valorLimpo;
            });
        });
    </script>
}