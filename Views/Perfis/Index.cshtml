@using Financeiro.Extensions
@model IEnumerable<Financeiro.Models.Perfil>

@{
    ViewData["Title"] = "Perfis de Acesso";
    Layout = "_Layout";
    
    // Permissões
    bool podeCriar = User.TemPermissao("PERFIL_ADD");
    bool podeEditar = User.TemPermissao("PERFIL_EDIT");
    bool podeExcluir = User.TemPermissao("PERFIL_DEL");
    
    // Verifica se o usuário tem ALGUMA permissão de ação
    bool podeAcoes = podeEditar || podeExcluir;

    // Paginação
    int paginaAtual = ViewBag.PaginaAtual ?? 1;
    int totalPaginas = ViewBag.TotalPaginas ?? 1;
}

<div id="pageFlags" data-success="@TempData["Sucesso"]" data-error="@TempData["Erro"]"></div>

<div class="container py-4">
    
    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="text-primary fw-bold mb-0">@ViewData["Title"]</h2>
            <small class="text-muted">Gerencie os níveis de acesso dos usuários.</small>
        </div>
        
        @if (podeCriar)
        {
            <a asp-action="Novo" class="btn btn-success rounded-pill px-4 shadow-sm">
                <i class="bi bi-plus-circle me-1"></i> Novo Perfil
            </a>
        }
    </div>

    <div class="card shadow-sm border-0 rounded-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small text-uppercase">
                    <tr>
                        <th class="ps-4">Nome do Perfil</th>
                        <th class="text-center" style="width: 150px;">Status</th>
                        <th class="text-end pe-4" style="width: 150px;">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="3" class="text-center py-4 text-muted">
                                Nenhum perfil ativo encontrado.
                            </td>
                        </tr>
                    }
                    else
                    {
                        @foreach (var perfil in Model)
                        {
                            <tr>
                                <td class="ps-4 fw-medium text-dark">@perfil.Nome</td>
                                
                                <td class="text-center">
                                    @if (perfil.Ativo)
                                    {
                                        <span class="badge rounded-pill bg-success"><i class='bi bi-check'></i> Ativo</span>
                                    }
                                    else
                                    {
                                        <span class="badge rounded-pill bg-secondary">Inativo</span>
                                    }
                                </td>

                                <td class="text-end pe-4">
                                    @if (podeAcoes)
                                    {
                                        <div class="btn-group">
                                            @if (podeEditar)
                                            {
                                                <a asp-action="Editar" asp-route-id="@perfil.Id" 
                                                   class="btn btn-sm btn-outline-primary" 
                                                   title="Editar">
                                                    <i class="bi bi-pencil"></i>
                                                </a>
                                            }
                                            
                                            @if (podeExcluir)
                                            {
                                                <button class="btn btn-sm btn-outline-danger js-delete" 
                                                        data-id="@perfil.Id" 
                                                        data-nome="@perfil.Nome"
                                                        title="Inativar">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        @* Ícone de cadeado para quem só tem permissão de VIEW *@
                                        <span class="text-muted opacity-50" title="Somente Leitura">
                                            <i class='bi bi-lock-fill fs-5'></i>
                                        </span>
                                    }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (totalPaginas > 1)
        {
            <div class="card-footer bg-white border-0 py-3">
                <nav aria-label="Navegação de página">
                    <ul class="pagination justify-content-center mb-0">
                        
                        <li class="page-item @(paginaAtual == 1 ? "disabled" : "")">
                            <a class="page-link border-0 shadow-none" asp-action="Index" asp-route-p="@(paginaAtual - 1)">
                                <i class='bi bi-chevron-left'></i>
                            </a>
                        </li>

                        @for (int i = 1; i <= totalPaginas; i++)
                        {
                            @if (i == 1 || i == totalPaginas || (i >= paginaAtual - 2 && i <= paginaAtual + 2))
                            {
                                <li class="page-item @(i == paginaAtual ? "active" : "")">
                                    <a class="page-link border-0 shadow-none" asp-action="Index" asp-route-p="@i">@i</a>
                                </li>
                            }
                            else if (i == paginaAtual - 3 || i == paginaAtual + 3)
                            {
                                <li class="page-item disabled"><span class="page-link border-0">...</span></li>
                            }
                        }

                        <li class="page-item @(paginaAtual == totalPaginas ? "disabled" : "")">
                            <a class="page-link border-0 shadow-none" asp-action="Index" asp-route-p="@(paginaAtual + 1)">
                                <i class='bi bi-chevron-right'></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                <div class="text-center mt-2 text-muted small">
                    Página @paginaAtual de @totalPaginas
                </div>
            </div>
        }
    </div>
</div>

<form id="form-excluir" method="post" style="display:none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // 1. Mensagens de Sucesso/Erro (Toast)
        const flags = document.getElementById('pageFlags');
        if(flags){
            if(flags.dataset.success) Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: flags.dataset.success, showConfirmButton: false, timer: 3000 });
            if(flags.dataset.error) Swal.fire({ icon: 'error', title: 'Erro', text: flags.dataset.error });
        }

        // 2. Confirmação de Inativação
        $('.js-delete').click(function() {
            const id = $(this).data('id');
            const nome = $(this).data('nome');
            
            Swal.fire({
                title: 'Inativar Perfil?',
                html: `Deseja realmente inativar o perfil <b>${nome}</b>?<br><small class='text-muted'>Usuários vinculados a ele perderão as permissões.</small>`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sim, inativar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    const form = $('#form-excluir');
                    form.attr('action', '/Perfis/Excluir/' + id);
                    form.submit();
                }
            });
        });
    </script>
}